project build/make/
diff --git a/core/Makefile b/core/Makefile
index a5eef489f..4610e2aaa 100644
--- a/core/Makefile
+++ b/core/Makefile
@@ -302,9 +302,9 @@ endif
 # Both of these tags will be removed and replaced with "release-keys"
 # when the target-files is signed in a post-build step.
 ifeq ($(DEFAULT_SYSTEM_DEV_CERTIFICATE),build/make/target/product/security/testkey)
-BUILD_KEYS := test-keys
+BUILD_KEYS := release-keys
 else
-BUILD_KEYS := dev-keys
+BUILD_KEYS := release-keys
 endif
 BUILD_VERSION_TAGS += $(BUILD_KEYS)
 BUILD_VERSION_TAGS := $(subst $(space),$(comma),$(sort $(BUILD_VERSION_TAGS)))
@@ -4281,7 +4281,7 @@ else
 endif

 ifeq ($(TARGET_BUILD_VARIANT),user)
-    $(INTERNAL_OTA_PACKAGE_TARGET): backuptool := false
+    $(INTERNAL_OTA_PACKAGE_TARGET): backuptool := true
 else
 ifneq ($(LINEAGE_BUILD),)
     $(INTERNAL_OTA_PACKAGE_TARGET): backuptool := true

diff --git a/core/binary.mk b/core/binary.mk
index d4f0476c8..2d6558e45 100644
--- a/core/binary.mk
+++ b/core/binary.mk
@@ -627,7 +627,7 @@ endif

 # Turn on all warnings and warnings as errors for RS compiles.
 # This can be disabled with LOCAL_RENDERSCRIPT_FLAGS := -Wno-error
-renderscript_flags := -Wall -Werror
+renderscript_flags := -Wall
 renderscript_flags += $(LOCAL_RENDERSCRIPT_FLAGS)
 # -m32 or -m64
 renderscript_flags += -m$(my_32_64_bit_suffix)
@@ -1504,10 +1504,10 @@ ifneq (HEADER_LIBRARIES,$(LOCAL_MODULE_CLASS))
       $(eval MODULES_USING_WNO_ERROR := $(MODULES_USING_WNO_ERROR) $(LOCAL_MODULE_MAKEFILE):$(LOCAL_MODULE))
     else
       # Issue warning if -Werror is not used. Add it.
-      ifeq (,$(filter -Werror,$(my_all_cflags)))
+      ifeq (,$(filter -Wall,$(my_all_cflags)))
         # Add -Wall -Werror unless the project is in the WARNING_ALLOWED project list.
         ifeq (,$(strip $(call find_warning_allowed_projects,$(LOCAL_PATH))))
-          my_cflags := -Wall -Werror $(my_cflags)
+          my_cflags := -Wall $(my_cflags)
         else
           $(eval MODULES_ADDED_WALL := $(MODULES_ADDED_WALL) $(LOCAL_MODULE_MAKEFILE):$(LOCAL_MODULE))
           my_cflags := -Wall $(my_cflags)

diff --git a/core/java_renderscript.mk b/core/java_renderscript.mk
index 13a6f8e66..72801a92d 100644
--- a/core/java_renderscript.mk
+++ b/core/java_renderscript.mk
@@ -46,7 +46,7 @@ endif

 # Turn on all warnings and warnings as errors for RS compiles.
 # This can be disabled with LOCAL_RENDERSCRIPT_FLAGS := -Wno-error
-renderscript_flags := -Wall -Werror
+renderscript_flags := -Wall
 renderscript_flags += $(LOCAL_RENDERSCRIPT_FLAGS)

 # prepend the RenderScript system include path

diff --git a/core/main.mk b/core/main.mk
index e8a1c4f8a..a86e7774a 100644
--- a/core/main.mk
+++ b/core/main.mk
@@ -292,8 +292,6 @@ ifneq (,$(user_variant))
   ADDITIONAL_DEFAULT_PROPERTIES += ro.allow.mock.location=0

 else # !user_variant
-  # Turn on checkjni for non-user builds.
-  ADDITIONAL_BUILD_PROPERTIES += ro.kernel.android.checkjni=1
   # Set device insecure for non-user builds.
   ADDITIONAL_DEFAULT_PROPERTIES += ro.secure=0
   # Allow mock locations by default for non user builds
@@ -303,8 +301,6 @@ endif # !user_variant
 ifeq (true,$(strip $(enable_target_debugging)))
   # Target is more debuggable and adbd is on by default
   ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=1
-  # Enable Dalvik lock contention logging.
-  ADDITIONAL_BUILD_PROPERTIES += dalvik.vm.lockprof.threshold=500
 else # !enable_target_debugging
   # Target is less debuggable and adbd is off by default
   ADDITIONAL_DEFAULT_PROPERTIES += ro.debuggable=0
@@ -322,7 +318,7 @@ ifneq ($(filter ro.setupwizard.mode=ENABLED, $(call collapse-pairs, $(ADDITIONAL
 endif
 ifndef is_sdk_build
   # To speedup startup of non-preopted builds, don't verify or compile the boot image.
-  ADDITIONAL_BUILD_PROPERTIES += dalvik.vm.image-dex2oat-filter=verify-at-runtime
+  ADDITIONAL_BUILD_PROPERTIES += dalvik.vm.image-dex2oat-filter=speed
 endif
 endif

diff --git a/core/product.mk b/core/product.mk
index da316cc42..226344344 100644
--- a/core/product.mk
+++ b/core/product.mk
@@ -493,10 +493,16 @@ _readonly_late_variables := \

 # Modified internally in the build system
 _readonly_late_variables += \
+  PRODUCT_ART_TARGET_INCLUDE_DEBUG_BUILD \
   PRODUCT_CFI_INCLUDE_PATHS \
   PRODUCT_COPY_FILES \
   PRODUCT_DEX_PREOPT_NEVER_ALLOW_STRIPPING \
   PRODUCT_DEX_PREOPT_BOOT_FLAGS \
+  PRODUCT_DEX_PREOPT_DEFAULT_FLAGS \
+  PRODUCT_DEX_PREOPT_DEFAULT_COMPILER_FILTER \
+  PRODUCT_SYSTEM_SERVER_COMPILER_FILTER \
+  PRODUCT_SYSTEM_SERVER_DEBUG_INFO \
+  PRODUCT_OTHER_JAVA_DEBUG_INFO \
   PRODUCT_SOONG_NAMESPACES

 _readonly_early_variables := $(filter-out $(_readonly_late_variables),$(_product_var_list))

diff --git a/target/product/base_system.mk b/target/product/base_system.mk
index 699b9c7a1..9071f7b54 100644
--- a/target/product/base_system.mk
+++ b/target/product/base_system.mk
@@ -45,8 +45,6 @@ PRODUCT_PACKAGES += \
     bootstat \
     bpfloader \
     bu \
-    bugreport \
-    bugreportz \
     cgroups.json \
     charger \
     cmd \
@@ -58,10 +56,6 @@ PRODUCT_PACKAGES += \
     com.android.tzdata \
     ContactsProvider \
     content \
-    crash_dump \
-    CtsShimPrebuilt \
-    CtsShimPrivPrebuilt \
-    debuggerd\
     device_config \
     dmctl \
     dnsmasq \
@@ -69,7 +63,6 @@ PRODUCT_PACKAGES += \
     dpm \
     dumpstate \
     dumpsys \
-    DynamicSystemInstallationService \
     e2fsck \
     ExtServices \
     ExtShared \
@@ -249,9 +242,6 @@ PRODUCT_PACKAGES += \
     tc \
     telecom \
     telephony-common \
-    tombstoned \
-    traced \
-    traced_probes \
     tune2fs \
     tzdatacheck \
     uiautomator \
@@ -261,7 +251,6 @@ PRODUCT_PACKAGES += \
     viewcompiler \
     voip-common \
     vold \
-    WallpaperBackup \
     watchdogd \
     wificond \
     wifi-service \
@@ -371,8 +360,7 @@ PRODUCT_PACKAGES_DEBUG := \

 # The set of packages whose code can be loaded by the system server.
 PRODUCT_SYSTEM_SERVER_APPS += \
-    SettingsProvider \
-    WallpaperBackup
+    SettingsProvider

diff --git a/target/product/full_base.mk b/target/product/full_base.mk
index f3fb8c306..832a1c7c9 100644
--- a/target/product/full_base.mk
+++ b/target/product/full_base.mk
@@ -24,8 +24,7 @@ PRODUCT_PACKAGES := \
     WAPPushManager

 PRODUCT_PACKAGES += \
-    LiveWallpapersPicker \
-    PhotoTable
+    LiveWallpapersPicker

 # Bluetooth:
 #   audio.a2dp.default is a system module. Generic system image includes

diff --git a/target/product/handheld_system.mk b/target/product/handheld_system.mk
index e5771cc94..7cd703b86 100644
--- a/target/product/handheld_system.mk
+++ b/target/product/handheld_system.mk
@@ -32,11 +32,9 @@ $(call inherit-product-if-exists, frameworks/base/data/keyboards/keyboards.mk)
 $(call inherit-product-if-exists, frameworks/webview/chromium/chromium.mk)

 PRODUCT_PACKAGES += \
-    BasicDreams \
     BlockedNumberProvider \
     Bluetooth \
     BluetoothMidiService \
-    BookmarkProvider \
     BuiltInPrintService \
     CalendarProvider \
     cameraserver \
@@ -46,7 +44,6 @@ PRODUCT_PACKAGES += \
     clatd.conf \
     DocumentsUI \
     DownloadProviderUi \
-    EasterEgg \
     ExternalStorageProvider \
     FusedLocation \
     InputDevices \
@@ -63,12 +60,10 @@ PRODUCT_PACKAGES += \
     ProxyHandler \
     screenrecord \
     SecureElement \
-    SharedStorageBackup \
     SimAppDialog \
     Telecom \
     TelephonyProvider \
     TeleService \
-    Traceur \
     UserDictionaryProvider \
     VpnDialogs \
     vr \

diff --git a/target/product/media_system.mk b/target/product/media_system.mk
index 0489b28d9..d29350b96 100644
--- a/target/product/media_system.mk
+++ b/target/product/media_system.mk
@@ -68,16 +68,6 @@ PRODUCT_COPY_FILES += $(call add-to-product-copy-files-if-exists,\
 PRODUCT_COPY_FILES += $(call add-to-product-copy-files-if-exists,\
     frameworks/base/dirty-image-objects-phone:system/etc/dirty-image-objects)

-# On userdebug builds, collect more tombstones by default.
-ifneq (,$(filter userdebug eng,$(TARGET_BUILD_VARIANT)))
-PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-    tombstoned.max_tombstone_count=50
-endif
-
-PRODUCT_DEFAULT_PROPERTY_OVERRIDES += \
-    ro.logd.size.stats=64K \
-    log.tag.stats_log=I
-
 # Enable CFI for security-sensitive components
 $(call inherit-product, $(SRC_TARGET_DIR)/product/cfi-common.mk)
 $(call inherit-product-if-exists, vendor/google/products/cfi-vendor.mk)

diff --git a/target/product/runtime_libart.mk b/target/product/runtime_libart.mk
index a88ba3c8d..ed19be911 100644
--- a/target/product/runtime_libart.mk
+++ b/target/product/runtime_libart.mk
@@ -61,22 +61,22 @@ PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
 # On eng builds, make "boot" reasons only extract for faster turnaround.
 ifeq (eng,$(TARGET_BUILD_VARIANT))
     PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-        pm.dexopt.first-boot=extract \
-        pm.dexopt.boot=extract
+        pm.dexopt.first-boot=speed \
+        pm.dexopt.boot=speed
 else
     PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-        pm.dexopt.first-boot=quicken \
-        pm.dexopt.boot=verify
+        pm.dexopt.first-boot=speed \
+        pm.dexopt.boot=speed
 endif

 # The install filter is speed-profile in order to enable the use of
 # profiles from the dex metadata files. Note that if a profile is not provided
 # or if it is empty speed-profile is equivalent to (quicken + empty app image).
 PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-    pm.dexopt.install=speed-profile \
-    pm.dexopt.bg-dexopt=speed-profile \
-    pm.dexopt.ab-ota=speed-profile \
-    pm.dexopt.inactive=verify \
+    pm.dexopt.install=speed \
+    pm.dexopt.bg-dexopt=speed \
+    pm.dexopt.ab-ota=speed \
+    pm.dexopt.inactive=speed \
     pm.dexopt.shared=speed

 # Enable resolution of startup const strings.
@@ -87,11 +87,6 @@ PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
 PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
     dalvik.vm.dex2oat-max-image-block-size=524288

-# Enable minidebuginfo generation unless overridden.
-PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
-    dalvik.vm.minidebuginfo=true \
-    dalvik.vm.dex2oat-minidebuginfo=true
-
 # Disable iorapd by default
 PRODUCT_SYSTEM_DEFAULT_PROPERTIES += \
     ro.iorapd.enable=false

diff --git a/target/product/telephony_system.mk b/target/product/telephony_system.mk
index 584cf1ee6..a6fe9682e 100644
--- a/target/product/telephony_system.mk
+++ b/target/product/telephony_system.mk
@@ -20,7 +20,6 @@
 PRODUCT_PACKAGES := \
     ONS \
-    CarrierDefaultApp \
-    CallLogBackup \
-    CellBroadcastReceiver \
+    CarrierDefaultApp

diff --git a/target/product/updatable_apex.mk b/target/product/updatable_apex.mk
index 3d5e8e2a2..bdaf54517 100644
--- a/target/product/updatable_apex.mk
+++ b/target/product/updatable_apex.mk
@@ -18,6 +18,5 @@

 ifneq ($(OVERRIDE_TARGET_FLATTEN_APEX),true)
   PRODUCT_PROPERTY_OVERRIDES := ro.apex.updatable=true
-  PRODUCT_PACKAGES := com.android.apex.cts.shim.v1_prebuilt
   TARGET_FLATTEN_APEX := false
 endif

diff --git a/tools/acp/Android.bp b/tools/acp/Android.bp
index 64f5a1013..8b84418b3 100644
--- a/tools/acp/Android.bp
+++ b/tools/acp/Android.bp
@@ -5,7 +5,7 @@
 cc_binary_host {

     srcs: ["acp.c"],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall"],

     static_libs: ["libhost"],
     name: "acp",

diff --git a/tools/atree/Android.bp b/tools/atree/Android.bp
index 5fbe042ea..fc8a8aada 100644
--- a/tools/atree/Android.bp
+++ b/tools/atree/Android.bp
@@ -9,6 +9,6 @@ cc_binary_host {
         "files.cpp",
         "fs.cpp",
     ],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall"],
     static_libs: ["libhost"],
 }

diff --git a/tools/fs_config/Android.bp b/tools/fs_config/Android.bp
index d9a48d704..60bfe673f 100644
--- a/tools/fs_config/Android.bp
+++ b/tools/fs_config/Android.bp
@@ -32,7 +32,6 @@ cc_binary_host {
         "libcutils",
         "libselinux",
     ],
-    cflags: ["-Werror"],
 }

 target_fs_config_gen_filegroup {

diff --git a/tools/fs_get_stats/Android.bp b/tools/fs_get_stats/Android.bp
index 67742b836..f710d506e 100644
--- a/tools/fs_get_stats/Android.bp
+++ b/tools/fs_get_stats/Android.bp
@@ -1,7 +1,7 @@
 cc_binary_host {
     name: "fs_get_stats",
     srcs: ["fs_get_stats.c"],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall"],
     shared_libs: [
         "libcutils",
         "liblog",

diff --git a/tools/libhost/Android.bp b/tools/libhost/Android.bp
index 4c9100f15..82268553b 100644
--- a/tools/libhost/Android.bp
+++ b/tools/libhost/Android.bp
@@ -3,7 +3,6 @@ cc_library_host_static {
     srcs: ["CopyFile.c"],

     cflags: [
-        "-Werror",
         "-Wall",
     ],

diff --git a/tools/makeparallel/Android.bp b/tools/makeparallel/Android.bp
index 898db6861..14be89ac2 100644
--- a/tools/makeparallel/Android.bp
+++ b/tools/makeparallel/Android.bp
@@ -17,5 +17,5 @@ cc_binary_host {
     srcs: [
         "makeparallel.cpp",
     ],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall"],
 }

diff --git a/tools/makeparallel/Makefile b/tools/makeparallel/Makefile
index 82a4abfac..b2595d45e 100644
--- a/tools/makeparallel/Makefile
+++ b/tools/makeparallel/Makefile
@@ -27,7 +27,7 @@ MAKEPARALLEL_BIN_PATH ?= .
 MAKEPARALLEL_CXX_SRCS := \
 	makeparallel.cpp

-MAKEPARALLEL_CXXFLAGS := -Wall -Werror -MMD -MP
+MAKEPARALLEL_CXXFLAGS := -Wall -MMD -MP

 MAKEPARALLEL_CXX_SRCS := $(addprefix $(MAKEPARALLEL_SRC_PATH)/,\
 	$(MAKEPARALLEL_CXX_SRCS))

diff --git a/tools/releasetools/common.py b/tools/releasetools/common.py
index b2afaf153..949b78f9e 100644
--- a/tools/releasetools/common.py
+++ b/tools/releasetools/common.py
@@ -2148,7 +2148,7 @@ class BlockDifference(object):
     #   decompression_time: 15s  | 25s                | 25s

     if not self.src:
-      brotli_cmd = ['brotli', '--quality=6',
+      brotli_cmd = ['brotli', '--quality=9',
                     '--output={}.new.dat.br'.format(self.path),
                     '{}.new.dat'.format(self.path)]
       print("Compressing {}.new.dat with brotli".format(self.partition))

diff --git a/tools/zipalign/Android.bp b/tools/zipalign/Android.bp
index 8e6196d29..9e65a5cf9 100644
--- a/tools/zipalign/Android.bp
+++ b/tools/zipalign/Android.bp
@@ -13,7 +13,7 @@ cc_binary_host {
         "ZipFile.cpp",
     ],

-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall"],

     // NOTE: Do not add any shared_libs dependencies because they will break the
     // static_sdk_tools target.

diff --git a/tools/ziptime/Android.bp b/tools/ziptime/Android.bp
index 5ef45ed40..7d882ae72 100644
--- a/tools/ziptime/Android.bp
+++ b/tools/ziptime/Android.bp
@@ -27,7 +27,7 @@ cc_binary_host {
     ],

     name: "ziptime",
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall"],
     target: {
         windows: {
             enabled: true,

project device/lineage/sepolicy/
diff --git a/common/private/backuptool.te b/common/private/backuptool.te
index b948b61..d62a3e0 100644
--- a/common/private/backuptool.te
+++ b/common/private/backuptool.te
@@ -6,6 +6,6 @@ neverallow {
     -update_engine
 } backuptool:process transition;

-userdebug_or_eng(`
+
     permissive backuptool;
-')
+

diff --git a/common/private/file_contexts b/common/private/file_contexts
index 09da0f6..4aee361 100644
--- a/common/private/file_contexts
+++ b/common/private/file_contexts
@@ -10,17 +10,14 @@
 /sys/devices(/platform)?/soc(\.[0-9])?/[a-f0-9]+\.ufshc/host[0-9]/target[0-9]+:[0-9]+:[0-9]+/[0-9]+:[0-9]+:[0-9]+:[0-9]+/block/sd[a-z]+/queue(/.*)? u:object_r:sysfs_io_sched_tuneable:s0
 /sys/devices/virtual/block/dm-[a-z0-9]+/queue(/.*)? u:object_r:sysfs_io_sched_tuneable:s0

-# OTA packages
-/data/lineageos_updates(/.*)?           u:object_r:ota_package_file:s0
-
 # Postinstall
 /system/bin/backuptool_ab\.functions              u:object_r:otapreopt_chroot_exec:s0
 /system/bin/backuptool_ab\.sh                     u:object_r:otapreopt_chroot_exec:s0
 /system/bin/backuptool_postinstall\.sh            u:object_r:otapreopt_chroot_exec:s0

+# Superuser's control sockets
+/dev/socket/su-daemon(/.*)?             u:object_r:superuser_device:s0
+
 # ADB Root
 /system/bin/adb_root       u:object_r:adbroot_exec:s0
 /data/adbroot(/.*)?        u:object_r:adbroot_data_file:s0
-
-# Bash
-/system/xbin/bash          u:object_r:shell_exec:s0

diff --git a/common/private/recovery.te b/common/private/recovery.te
index 2b6f7fa..2461781 100644
--- a/common/private/recovery.te
+++ b/common/private/recovery.te
@@ -1,7 +1,7 @@
 recovery_only(`
-userdebug_or_eng(`
+
 permissive recovery;
-')
+

 # Volume manager
 allow recovery block_device:dir create_dir_perms;

project external/bash/
diff --git a/Android.mk b/Android.mk
index 1a23613..f5aea6a 100644
--- a/Android.mk
+++ b/Android.mk
@@ -61,22 +61,5 @@ LOCAL_MODULE_TAGS := optional

 include $(BUILD_EXECUTABLE)

-# ========================================================
-# bash configs
-# ========================================================
-etc_files := $(wildcard $(LOCAL_PATH)/etc/*)
-
-BASH_ETC := $(TARGET_OUT)/etc/$(LOCAL_MODULE)
-BASH_CONFIGS := $(addprefix $(BASH_ETC)/,$(notdir $(etc_files)))
-$(BASH_CONFIGS): $(BASH_ETC)/%: $(LOCAL_PATH)/etc/% | $(LOCAL_BUILT_MODULE)
-       @echo "Install: $@ -> $(BASH_ETC)"
-       @mkdir -p $(dir $@)
-       $(hide) cp $< $@
-
-ALL_DEFAULT_INSTALLED_MODULES += $(BASH_CONFIGS)
-
-ALL_MODULES.$(LOCAL_MODULE).INSTALLED := \
-    $(ALL_MODULES.$(LOCAL_MODULE).INSTALLED) $(BASH_CONFIGS)
-
 # ========================================================
 include $(call all-makefiles-under,$(LOCAL_PATH))

project external/mksh/
diff --git a/mkshrc b/mkshrc
index 256f20e..f7bab3a 100644
--- a/mkshrc
+++ b/mkshrc
@@ -6,15 +6,23 @@
 #
 # Support: https://launchpad.net/mksh

-set +o nohup
-
+: ${TERM:=xterm-256color} ${HOME:=/} ${MKSH:=/system/bin/sh} ${HOSTNAME:=android} ${SHELL:=$MKSH} ${USER:=$(getprop ro.product.device)}
 if (( USER_ID )); then PS1='$'; else PS1='#'; fi
-PS4='[$EPOCHREALTIME] '; PS1='${|
-	local e=$?

-	(( e )) && REPLY+="$e|"
+PS1='$USER@$HOSTNAME:${PWD:-?} '"$PS1 "
+
+if [ -d "/sbin/.magisk/busybox" ]; then
+  BUSYBOX="/sbin/.magisk/busybox"
+elif [ -d "/sbin/.core/busybox" ]; then
+  BUSYBOX="/sbin/.core/busybox"
+fi
+
+PATH=$PATH:/sbin:$BUSYBOX:.
+export TERM HOME MKSH HOSTNAME SHELL USER PATH

-	return $e
-}$HOSTNAME:${PWD:-?} '"$PS1 "
+for p in ~/.bin; do
+	[[ -d $p/. ]] || continue
+	[[ :$PATH: = *:$p:* ]] || PATH=$p:$PATH
+done

-export TERM=xterm-256color
+unset p

project external/noto-fonts/
diff --git a/Android.mk b/Android.mk
index 249c7ac..d39a9d3 100644
--- a/Android.mk
+++ b/Android.mk
@@ -41,28 +41,13 @@ ifneq ($(MINIMAL_FONT_FOOTPRINT),true)
 LOCAL_PATH := $(NOTO_DIR)/cjk

 font_src_files := \
-    NotoSansCJK-Regular.ttc
+    NotoSansCJK.ttc

 $(foreach f, $(font_src_files), $(call build-one-font-module, $(f)))
 font_src_files :=

 endif # !MINIMAL_FONT_FOOTPRINT

-#############################################################################
-# Similary "build" the Noto CJK fonts for serif family.
-# These are not included in SMALLER_FONT_FOOTPRINT builds.
-#############################################################################
-ifeq ($(filter true,$(EXCLUDE_SERIF_FONTS) $(SMALLER_FONT_FOOTPRINT)),)
-LOCAL_PATH := $(NOTO_DIR)/cjk
-
-font_src_files := \
-    NotoSerifCJK-Regular.ttc
-
-$(foreach f, $(font_src_files), $(call build-one-font-module, $(f)))
-font_src_files :=
-
-endif # !EXCLUDE_SERIF_FONTS && !SMALLER_FONT_FOOTPRINT
-
 #############################################################################
 # Now "build" the Noto Color Emoji font, which is in its own directory. It is
 # not included in the MINIMAL_FONT_FOOTPRINT builds.

diff --git a/cjk/subset_noto_cjk.py b/cjk/subset_noto_cjk.py
index 5a324bf..4a274ce 100755
--- a/cjk/subset_noto_cjk.py
+++ b/cjk/subset_noto_cjk.py
@@ -98,6 +98,6 @@ def remove_codepoints_from_ttc(ttc_name):
         for f in otf_names:
             os.remove(f)

-
+remove_codepoints_from_ttc('NotoSansCJK.ttc')
 remove_codepoints_from_ttc('NotoSansCJK-Regular.ttc')
 remove_codepoints_from_ttc('NotoSerifCJK-Regular.ttc')

diff --git a/fonts.mk b/fonts.mk
index fee43e2..1e3cf5e 100644
--- a/fonts.mk
+++ b/fonts.mk
@@ -49,7 +49,7 @@ PRODUCT_PACKAGES := \
     NotoSansCham-Bold.ttf \
     NotoSansCham-Regular.ttf \
     NotoSansCherokee-Regular.ttf \
-    NotoSansCJK-Regular.ttc \
+    NotoSansCJK.ttc \
     NotoSansCoptic-Regular.ttf \
     NotoSansCuneiform-Regular.ttf \
     NotoSansCypriot-Regular.ttf \
@@ -205,7 +205,6 @@ PRODUCT_PACKAGES := \
     NotoSerifArmenian-Regular.otf \
     NotoSerifBengali-Bold.ttf \
     NotoSerifBengali-Regular.ttf \
-    NotoSerifCJK-Regular.ttc \
     NotoSerifDevanagari-Bold.ttf \
     NotoSerifDevanagari-Regular.ttf \
     NotoSerifEthiopic-Bold.otf \

diff --git a/other/NotoSerif-Bold.ttf b/other/NotoSerif-Bold.ttf
index 2ffdf8c..128288b 100644
Binary files a/other/NotoSerif-Bold.ttf and b/other/NotoSerif-Bold.ttf differ

diff --git a/other/NotoSerif-Regular.ttf b/other/NotoSerif-Regular.ttf
index 9d9a347..78136ac 100644
Binary files a/other/NotoSerif-Regular.ttf and b/other/NotoSerif-Regular.ttf differ

project frameworks/base/
diff --git a/Android.bp b/Android.bp
index bdd88034655..5890b491d21 100644
--- a/Android.bp
+++ b/Android.bp
@@ -782,11 +782,6 @@ java_defaults {
         "devicepolicyprotosnano",
     ],

-    required: [
-        // TODO: remove gps_debug when the build system propagates "required" properly.
-        "gps_debug.conf",
-    ],
-
     dxflags: [
         "--core-library",
         "--multi-dex",

diff --git a/core/java/android/app/SystemServiceRegistry.java b/core/java/android/app/SystemServiceRegistry.java
index d1090a348e7..66e976c2972 100644
--- a/core/java/android/app/SystemServiceRegistry.java
+++ b/core/java/android/app/SystemServiceRegistry.java
@@ -131,7 +131,6 @@ import android.os.BatteryStats;
 import android.os.BugreportManager;
 import android.os.Build;
 import android.os.DeviceIdleManager;
-import android.os.DropBoxManager;
 import android.os.HardwarePropertiesManager;
 import android.os.IBatteryPropertiesRegistrar;
 import android.os.IBinder;
@@ -194,7 +193,6 @@ import com.android.internal.app.IBatteryStats;
 import com.android.internal.app.ISoundTriggerService;
 import com.android.internal.appwidget.IAppWidgetService;
 import com.android.internal.net.INetworkWatchlistManager;
-import com.android.internal.os.IDropBoxManagerService;
 import com.android.internal.policy.PhoneLayoutInflater;

 import java.util.Map;
@@ -412,15 +410,6 @@ final class SystemServiceRegistry {
                 return new NfcManager(ctx);
             }});

-        registerService(Context.DROPBOX_SERVICE, DropBoxManager.class,
-                new CachedServiceFetcher<DropBoxManager>() {
-            @Override
-            public DropBoxManager createService(ContextImpl ctx) throws ServiceNotFoundException {
-                IBinder b = ServiceManager.getServiceOrThrow(Context.DROPBOX_SERVICE);
-                IDropBoxManagerService service = IDropBoxManagerService.Stub.asInterface(b);
-                return new DropBoxManager(ctx, service);
-            }});
-
         registerService(Context.INPUT_SERVICE, InputManager.class,
                 new StaticServiceFetcher<InputManager>() {
             @Override

diff --git a/core/res/AndroidManifest.xml b/core/res/AndroidManifest.xml
index 7bcd7a048db..5f7fde41669 100644
--- a/core/res/AndroidManifest.xml
+++ b/core/res/AndroidManifest.xml
@@ -2655,6 +2655,13 @@
         android:description="@string/permdesc_getPackageSize"
         android:protectionLevel="normal" />

+    <!-- @hide Allows an application to change the package signature as
+         seen by applications -->
+    <permission android:name="android.permission.FAKE_PACKAGE_SIGNATURE"
+        android:protectionLevel="dangerous"
+        android:label="@string/permlab_fakePackageSignature"
+        android:description="@string/permdesc_fakePackageSignature" />
+
     <!-- @deprecated No longer useful, see
          {@link android.content.pm.PackageManager#addPackageToPreferred}
          for details. -->

diff --git a/core/res/res/values-zh-rCN/strings.xml b/core/res/res/values-zh-rCN/strings.xml
index aae5771e8b0..e6a17338b5d 100644
--- a/core/res/res/values-zh-rCN/strings.xml
+++ b/core/res/res/values-zh-rCN/strings.xml
@@ -2050,4 +2050,6 @@
     </plurals>
     <string name="chooser_no_direct_share_targets" msgid="492542066060841139">"无法使用直接分享功能"</string>
     <string name="chooser_all_apps_button_label" msgid="3230427756238666328">"应用列表"</string>
+    <string name="permlab_fakePackageSignature">模拟软件包签名</string>
+    <string name="permdesc_fakePackageSignature">允许应用伪装成为其他应用</string>
 </resources>

diff --git a/core/res/res/values/config.xml b/core/res/res/values/config.xml
index a84d23b624b..89754ba11ef 100644
--- a/core/res/res/values/config.xml
+++ b/core/res/res/values/config.xml
@@ -1875,6 +1875,8 @@
     <string-array name="config_locationProviderPackageNames" translatable="false">
         <!-- The standard AOSP fused location provider -->
         <item>com.android.location.fused</item>
+        <!-- The (faked) microg fused location provider (a free reimplementation) -->
+        <item>com.google.android.gms</item>
     </string-array>

     <!-- This string array can be overriden to enable test location providers initially. -->

diff --git a/core/res/res/values/strings.xml b/core/res/res/values/strings.xml
index 40270e62e11..7326786349e 100644
--- a/core/res/res/values/strings.xml
+++ b/core/res/res/values/strings.xml
@@ -830,6 +830,11 @@

     <!--  Permissions -->

+    <!-- Title of an application permission, listed so the user can choose whether they want to allow the application to do this. -->
+    <string name="permlab_fakePackageSignature">Spoof package signature</string>
+    <!-- Description of an application permission, listed so the user can choose whether they want to allow the application to do this. -->
+    <string name="permdesc_fakePackageSignature">Allows the app to pretend to be a different app.</string>
+
     <!-- Title of an application permission, listed so the user can choose whether they want to allow the application to do this. -->
     <string name="permlab_statusBar">disable or modify status bar</string>
     <!-- Description of an application permission, listed so the user can choose whether they want to allow the application to do this. -->

diff --git a/data/fonts/fonts.xml b/data/fonts/fonts.xml
index c6920977f6b..b993005e015 100644
--- a/data/fonts/fonts.xml
+++ b/data/fonts/fonts.xml
@@ -546,20 +546,56 @@
         <font weight="400" style="normal">NotoSansSymbols-Regular-Subsetted.ttf</font>
     </family>
     <family lang="zh-Hans">
-        <font weight="400" style="normal" index="2">NotoSansCJK-Regular.ttc</font>
-        <font weight="400" style="normal" index="2" fallbackFor="serif">NotoSerifCJK-Regular.ttc</font>
-    </family>
-    <family lang="zh-Hant,zh-Bopo">
-        <font weight="400" style="normal" index="3">NotoSansCJK-Regular.ttc</font>
-        <font weight="400" style="normal" index="3" fallbackFor="serif">NotoSerifCJK-Regular.ttc</font>
+        <font weight="100" style="normal" index="2">NotoSansCJK.ttc</font>
+        <font weight="300" style="normal" index="7">NotoSansCJK.ttc</font>
+        <font weight="350" style="normal" index="12">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" index="17">NotoSansCJK.ttc</font>
+        <font weight="500" style="normal" index="27">NotoSansCJK.ttc</font>
+        <font weight="700" style="normal" index="32">NotoSansCJK.ttc</font>
+        <font weight="900" style="normal" index="42">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" fallbackFor="serif">NotoSerif-Regular.ttf</font>
+        <font weight="700" style="normal" fallbackFor="serif">NotoSerif-Bold.ttf</font>
+        <font weight="400" style="italic" fallbackFor="serif">NotoSerif-Italic.ttf</font>
+        <font weight="700" style="italic" fallbackFor="serif">NotoSerif-BoldItalic.ttf</font>
+    </family>
+    <family lang="zh-Hant zh-Bopo">
+        <font weight="100" style="normal" index="3">NotoSansCJK.ttc</font>
+        <font weight="300" style="normal" index="8">NotoSansCJK.ttc</font>
+        <font weight="350" style="normal" index="13">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" index="18">NotoSansCJK.ttc</font>
+        <font weight="500" style="normal" index="28">NotoSansCJK.ttc</font>
+        <font weight="700" style="normal" index="33">NotoSansCJK.ttc</font>
+        <font weight="900" style="normal" index="43">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" fallbackFor="serif">NotoSerif-Regular.ttf</font>
+        <font weight="700" style="normal" fallbackFor="serif">NotoSerif-Bold.ttf</font>
+        <font weight="400" style="italic" fallbackFor="serif">NotoSerif-Italic.ttf</font>
+        <font weight="700" style="italic" fallbackFor="serif">NotoSerif-BoldItalic.ttf</font>
     </family>
     <family lang="ja">
-        <font weight="400" style="normal" index="0">NotoSansCJK-Regular.ttc</font>
-        <font weight="400" style="normal" index="0" fallbackFor="serif">NotoSerifCJK-Regular.ttc</font>
+        <font weight="100" style="normal" index="0">NotoSansCJK.ttc</font>
+        <font weight="300" style="normal" index="5">NotoSansCJK.ttc</font>
+        <font weight="350" style="normal" index="10">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" index="15">NotoSansCJK.ttc</font>
+        <font weight="500" style="normal" index="25">NotoSansCJK.ttc</font>
+        <font weight="700" style="normal" index="30">NotoSansCJK.ttc</font>
+        <font weight="900" style="normal" index="40">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" fallbackFor="serif">NotoSerif-Regular.ttf</font>
+        <font weight="700" style="normal" fallbackFor="serif">NotoSerif-Bold.ttf</font>
+        <font weight="400" style="italic" fallbackFor="serif">NotoSerif-Italic.ttf</font>
+        <font weight="700" style="italic" fallbackFor="serif">NotoSerif-BoldItalic.ttf</font>
     </family>
     <family lang="ko">
-        <font weight="400" style="normal" index="1">NotoSansCJK-Regular.ttc</font>
-        <font weight="400" style="normal" index="1" fallbackFor="serif">NotoSerifCJK-Regular.ttc</font>
+        <font weight="100" style="normal" index="1">NotoSansCJK.ttc</font>
+        <font weight="300" style="normal" index="6">NotoSansCJK.ttc</font>
+        <font weight="350" style="normal" index="11">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" index="16">NotoSansCJK.ttc</font>
+        <font weight="500" style="normal" index="26">NotoSansCJK.ttc</font>
+        <font weight="700" style="normal" index="31">NotoSansCJK.ttc</font>
+        <font weight="900" style="normal" index="41">NotoSansCJK.ttc</font>
+        <font weight="400" style="normal" fallbackFor="serif">NotoSerif-Regular.ttf</font>
+        <font weight="700" style="normal" fallbackFor="serif">NotoSerif-Bold.ttf</font>
+        <font weight="400" style="italic" fallbackFor="serif">NotoSerif-Italic.ttf</font>
+        <font weight="700" style="italic" fallbackFor="serif">NotoSerif-BoldItalic.ttf</font>
     </family>
     <family lang="und-Zsye">
         <font weight="400" style="normal">NotoColorEmoji.ttf</font>

diff --git a/packages/overlays/Android.mk b/packages/overlays/Android.mk
index eecc10158e8..c1f3f17d361 100644
--- a/packages/overlays/Android.mk
+++ b/packages/overlays/Android.mk
@@ -17,16 +17,6 @@ include $(CLEAR_VARS)

 LOCAL_MODULE := frameworks-base-overlays
 LOCAL_REQUIRED_MODULES := \
-	AccentColorBlackOverlay \
-	AccentColorCinnamonOverlay \
-	AccentColorOceanOverlay \
-	AccentColorOrchidOverlay \
-	AccentColorSpaceOverlay \
-	AccentColorGreenOverlay \
-	AccentColorPurpleOverlay \
-	DisplayCutoutEmulationCornerOverlay \
-	DisplayCutoutEmulationDoubleOverlay \
-	DisplayCutoutEmulationTallOverlay \
 	FontNotoSerifSourceOverlay \
 	IconPackCircularAndroidOverlay \
 	IconPackCircularLauncherOverlay \

diff --git a/services/core/Android.bp b/services/core/Android.bp
index 6edd33c8d35..74a15839588 100644
--- a/services/core/Android.bp
+++ b/services/core/Android.bp
@@ -32,10 +32,6 @@ java_library_static {
         "org.lineageos.platform.internal",
     ],

-    required: [
-        "gps_debug.conf",
-    ],
-
     static_libs: [
         "time_zone_distro",
         "time_zone_distro_installer",
@@ -76,9 +72,3 @@ java_library {
     name: "services.core",
     static_libs: ["services.core.priorityboosted"],
 }
-
-
-prebuilt_etc {
-    name: "gps_debug.conf",
-    src: "java/com/android/server/location/gps_debug.conf",
-}

diff --git a/services/core/java/com/android/server/BatteryService.java b/services/core/java/com/android/server/BatteryService.java
index d041476a1d6..d2d30d00981 100644
--- a/services/core/java/com/android/server/BatteryService.java
+++ b/services/core/java/com/android/server/BatteryService.java
@@ -37,7 +37,6 @@ import android.os.BatteryProperty;
 import android.os.BatteryStats;
 import android.os.Binder;
 import android.os.Bundle;
-import android.os.DropBoxManager;
 import android.os.FileUtils;
 import android.os.Handler;
 import android.os.HandlerThread;
@@ -775,9 +774,6 @@ public final class BatteryService extends SystemService {
         IBinder batteryInfoService = ServiceManager.getService(BatteryStats.SERVICE_NAME);
         if (batteryInfoService == null) return;

-        DropBoxManager db = (DropBoxManager) mContext.getSystemService(Context.DROPBOX_SERVICE);
-        if (db == null || !db.isTagEnabled("BATTERY_DISCHARGE_INFO")) return;
-
         File dumpFile = null;
         FileOutputStream dumpStream = null;
         try {
@@ -787,8 +783,6 @@ public final class BatteryService extends SystemService {
             batteryInfoService.dump(dumpStream.getFD(), DUMPSYS_ARGS);
             FileUtils.sync(dumpStream);

-            // add dump file to drop box
-            db.addFile("BATTERY_DISCHARGE_INFO", dumpFile, DropBoxManager.IS_TEXT);
         } catch (RemoteException e) {
             Slog.e(TAG, "failed to dump battery service", e);
         } catch (IOException e) {

diff --git a/services/core/java/com/android/server/DropBoxManagerService.java b/services/core/java/com/android/server/DropBoxManagerService.java
deleted file mode 100644
index 33b846f7bb5..00000000000
--- a/services/core/java/com/android/server/DropBoxManagerService.java
+++ /dev/null

diff --git a/services/core/java/com/android/server/StorageManagerService.java b/services/core/java/com/android/server/StorageManagerService.java
index 263efacb097..9404aedfba4 100644
--- a/services/core/java/com/android/server/StorageManagerService.java
+++ b/services/core/java/com/android/server/StorageManagerService.java
@@ -70,7 +70,6 @@ import android.content.res.ObbInfo;
 import android.database.ContentObserver;
 import android.net.Uri;
 import android.os.Binder;
-import android.os.DropBoxManager;
 import android.os.Environment;
 import android.os.Environment.UserEnvironment;
 import android.os.FileUtils;
@@ -1874,10 +1873,6 @@ class StorageManagerService extends IStorageManager.Stub
                     final long run = extras.getLong("run");
                     final long destroy = extras.getLong("destroy");

-                    final DropBoxManager dropBox = mContext.getSystemService(DropBoxManager.class);
-                    dropBox.addText(TAG_STORAGE_BENCHMARK, scrubPath(path)
-                            + " " + ident + " " + create + " " + run + " " + destroy);
-
                     synchronized (mLock) {
                         final VolumeRecord rec = findRecordForPath(path);
                         if (rec != null) {
@@ -2037,9 +2032,6 @@ class StorageManagerService extends IStorageManager.Stub
                         final long bytes = extras.getLong("bytes");
                         final long time = extras.getLong("time");

-                        final DropBoxManager dropBox = mContext.getSystemService(DropBoxManager.class);
-                        dropBox.addText(TAG_STORAGE_TRIM, scrubPath(path) + " " + bytes + " " + time);
-
                         synchronized (mLock) {
                             final VolumeRecord rec = findRecordForPath(path);
                             if (rec != null) {

diff --git a/services/core/java/com/android/server/Watchdog.java b/services/core/java/com/android/server/Watchdog.java
index 5b9c78f6e8e..289bdd31e12 100644
--- a/services/core/java/com/android/server/Watchdog.java
+++ b/services/core/java/com/android/server/Watchdog.java
@@ -613,26 +613,6 @@ public class Watchdog extends Thread {
             doSysRq('w');
             doSysRq('l');

-            // Try to add the error to the dropbox, but assuming that the ActivityManager
-            // itself may be deadlocked.  (which has happened, causing this statement to
-            // deadlock and the watchdog as a whole to be ineffective)
-            Thread dropboxThread = new Thread("watchdogWriteToDropbox") {
-                    public void run() {
-                        // If a watched thread hangs before init() is called, we don't have a
-                        // valid mActivity. So we can't log the error to dropbox.
-                        if (mActivity != null) {
-                            mActivity.addErrorToDropBox(
-                                    "watchdog", null, "system_server", null, null, null,
-                                    subject, null, stack, null);
-                        }
-                        StatsLog.write(StatsLog.SYSTEM_SERVER_WATCHDOG_OCCURRED, subject);
-                    }
-                };
-            dropboxThread.start();
-            try {
-                dropboxThread.join(2000);  // wait up to 2 seconds for it to return.
-            } catch (InterruptedException ignored) {}
-
             IActivityController controller;
             synchronized (this) {
                 controller = mController;

diff --git a/services/core/java/com/android/server/am/ActivityManagerService.java b/services/core/java/com/android/server/am/ActivityManagerService.java
index 3ad4954d33c..f1ea5772609 100644
--- a/services/core/java/com/android/server/am/ActivityManagerService.java
+++ b/services/core/java/com/android/server/am/ActivityManagerService.java
@@ -241,7 +241,6 @@ import android.os.BinderProxy;
 import android.os.Build;
 import android.os.Bundle;
 import android.os.Debug;
-import android.os.DropBoxManager;
 import android.os.FactoryTest;
 import android.os.FileUtils;
 import android.os.Handler;
@@ -484,8 +483,6 @@ public class ActivityManagerService extends IActivityManager.Stub

     static final String[] EMPTY_STRING_ARRAY = new String[0];

-    // How many bytes to write into the dropbox log before truncating
-    static final int DROPBOX_MAX_SIZE = 192 * 1024;
     // Assumes logcat entries average around 100 bytes; that's not perfect stack traces count
     // as one line, but close enough for now.
     static final int RESERVED_BYTES_PER_LOGCAT_LINE = 100;
@@ -9256,9 +9253,6 @@ public class ActivityManagerService extends IActivityManager.Stub
             crashInfo.crashTag = crashInfo.crashTag + " " + relaunchReasonString;
         }

-        addErrorToDropBox(
-                eventType, r, processName, null, null, null, null, null, null, crashInfo);
-
         mAppErrors.crashApplication(r, crashInfo);
     }

@@ -9289,9 +9283,6 @@ public class ActivityManagerService extends IActivityManager.Stub
                     mAlreadyLoggedViolatedStacks.add(stackFingerprint);
                 }
             }
-            if (logIt) {
-                logStrictModeViolationToDropBox(r, info);
-            }
         }

         if ((penaltyMask & StrictMode.PENALTY_DIALOG) != 0) {
@@ -9315,68 +9306,6 @@ public class ActivityManagerService extends IActivityManager.Stub
         }
     }

-    // Depending on the policy in effect, there could be a bunch of
-    // these in quick succession so we try to batch these together to
-    // minimize disk writes, number of dropbox entries, and maximize
-    // compression, by having more fewer, larger records.
-    private void logStrictModeViolationToDropBox(
-            ProcessRecord process,
-            StrictMode.ViolationInfo info) {
-        if (info == null) {
-            return;
-        }
-        final boolean isSystemApp = process == null ||
-                (process.info.flags & (ApplicationInfo.FLAG_SYSTEM |
-                                       ApplicationInfo.FLAG_UPDATED_SYSTEM_APP)) != 0;
-        final String processName = process == null ? "unknown" : process.processName;
-        final DropBoxManager dbox = (DropBoxManager)
-                mContext.getSystemService(Context.DROPBOX_SERVICE);
-
-        // Exit early if the dropbox isn't configured to accept this report type.
-        final String dropboxTag = processClass(process) + "_strictmode";
-        if (dbox == null || !dbox.isTagEnabled(dropboxTag)) return;
-
-        final StringBuilder sb = new StringBuilder(1024);
-        synchronized (sb) {
-            appendDropBoxProcessHeaders(process, processName, sb);
-            sb.append("Build: ").append(Build.FINGERPRINT).append("\n");
-            sb.append("System-App: ").append(isSystemApp).append("\n");
-            sb.append("Uptime-Millis: ").append(info.violationUptimeMillis).append("\n");
-            if (info.violationNumThisLoop != 0) {
-                sb.append("Loop-Violation-Number: ").append(info.violationNumThisLoop).append("\n");
-            }
-            if (info.numAnimationsRunning != 0) {
-                sb.append("Animations-Running: ").append(info.numAnimationsRunning).append("\n");
-            }
-            if (info.broadcastIntentAction != null) {
-                sb.append("Broadcast-Intent-Action: ").append(info.broadcastIntentAction).append("\n");
-            }
-            if (info.durationMillis != -1) {
-                sb.append("Duration-Millis: ").append(info.durationMillis).append("\n");
-            }
-            if (info.numInstances != -1) {
-                sb.append("Instance-Count: ").append(info.numInstances).append("\n");
-            }
-            if (info.tags != null) {
-                for (String tag : info.tags) {
-                    sb.append("Span-Tag: ").append(tag).append("\n");
-                }
-            }
-            sb.append("\n");
-            sb.append(info.getStackTrace());
-            sb.append("\n");
-            if (info.getViolationDetails() != null) {
-                sb.append(info.getViolationDetails());
-                sb.append("\n");
-            }
-        }
-
-        final String res = sb.toString();
-        IoThread.getHandler().post(() -> {
-            dbox.addText(dropboxTag, res);
-        });
-    }
-
     /**
      * Used by {@link Log} via {@link com.android.internal.os.RuntimeInit} to report serious errors.
      * @param app object of the crashing app, null for the system server
@@ -9429,8 +9358,6 @@ public class ActivityManagerService extends IActivityManager.Stub
         StatsLog.write(StatsLog.WTF_OCCURRED, callingUid, tag, processName,
                 callingPid, (r != null) ? r.getProcessClassEnum() : 0);

-        addErrorToDropBox("wtf", r, processName, null, null, null, tag, null, null, crashInfo);
-
         return r;
     }

@@ -9448,54 +9375,6 @@ public class ActivityManagerService extends IActivityManager.Stub
         }
     }

-    /**
-     * Utility function for addErrorToDropBox and handleStrictModeViolation's logging
-     * to append various headers to the dropbox log text.
-     */
-    private void appendDropBoxProcessHeaders(ProcessRecord process, String processName,
-            StringBuilder sb) {
-        // Watchdog thread ends up invoking this function (with
-        // a null ProcessRecord) to add the stack file to dropbox.
-        // Do not acquire a lock on this (am) in such cases, as it
-        // could cause a potential deadlock, if and when watchdog
-        // is invoked due to unavailability of lock on am and it
-        // would prevent watchdog from killing system_server.
-        if (process == null) {
-            sb.append("Process: ").append(processName).append("\n");
-            return;
-        }
-        // Note: ProcessRecord 'process' is guarded by the service
-        // instance.  (notably process.pkgList, which could otherwise change
-        // concurrently during execution of this method)
-        synchronized (this) {
-            sb.append("Process: ").append(processName).append("\n");
-            sb.append("PID: ").append(process.pid).append("\n");
-            sb.append("UID: ").append(process.uid).append("\n");
-            int flags = process.info.flags;
-            IPackageManager pm = AppGlobals.getPackageManager();
-            sb.append("Flags: 0x").append(Integer.toHexString(flags)).append("\n");
-            for (int ip=0; ip<process.pkgList.size(); ip++) {
-                String pkg = process.pkgList.keyAt(ip);
-                sb.append("Package: ").append(pkg);
-                try {
-                    PackageInfo pi = pm.getPackageInfo(pkg, 0, UserHandle.getCallingUserId());
-                    if (pi != null) {
-                        sb.append(" v").append(pi.getLongVersionCode());
-                        if (pi.versionName != null) {
-                            sb.append(" (").append(pi.versionName).append(")");
-                        }
-                    }
-                } catch (RemoteException e) {
-                    Slog.e(TAG, "Error getting package info: " + pkg, e);
-                }
-                sb.append("\n");
-            }
-            if (process.info.isInstantApp()) {
-                sb.append("Instant-App: true\n");
-            }
-        }
-    }
-
     private static String processClass(ProcessRecord process) {
         if (process == null || process.pid == MY_PID) {
             return "system_server";
@@ -9509,144 +9388,6 @@ public class ActivityManagerService extends IActivityManager.Stub
     private volatile long mWtfClusterStart;
     private volatile int mWtfClusterCount;

-    /**
-     * Write a description of an error (crash, WTF, ANR) to the drop box.
-     * @param eventType to include in the drop box tag ("crash", "wtf", etc.)
-     * @param process which caused the error, null means the system server
-     * @param activityShortComponentName which triggered the error, null if unknown
-     * @param parentShortComponentName activity related to the error, null if unknown
-     * @param parentProcess parent process
-     * @param subject line related to the error, null if absent
-     * @param report in long form describing the error, null if absent
-     * @param dataFile text file to include in the report, null if none
-     * @param crashInfo giving an application stack trace, null if absent
-     */
-    public void addErrorToDropBox(String eventType,
-            ProcessRecord process, String processName, String activityShortComponentName,
-            String parentShortComponentName, ProcessRecord parentProcess,
-            String subject, final String report, final File dataFile,
-            final ApplicationErrorReport.CrashInfo crashInfo) {
-        // NOTE -- this must never acquire the ActivityManagerService lock,
-        // otherwise the watchdog may be prevented from resetting the system.
-
-        // Bail early if not published yet
-        if (ServiceManager.getService(Context.DROPBOX_SERVICE) == null) return;
-        final DropBoxManager dbox = mContext.getSystemService(DropBoxManager.class);
-
-        // Exit early if the dropbox isn't configured to accept this report type.
-        final String dropboxTag = processClass(process) + "_" + eventType;
-        if (dbox == null || !dbox.isTagEnabled(dropboxTag)) return;
-
-        // Rate-limit how often we're willing to do the heavy lifting below to
-        // collect and record logs; currently 5 logs per 10 second period.
-        final long now = SystemClock.elapsedRealtime();
-        if (now - mWtfClusterStart > 10 * DateUtils.SECOND_IN_MILLIS) {
-            mWtfClusterStart = now;
-            mWtfClusterCount = 1;
-        } else {
-            if (mWtfClusterCount++ >= 5) return;
-        }
-
-        final StringBuilder sb = new StringBuilder(1024);
-        appendDropBoxProcessHeaders(process, processName, sb);
-        if (process != null) {
-            sb.append("Foreground: ")
-                    .append(process.isInterestingToUserLocked() ? "Yes" : "No")
-                    .append("\n");
-        }
-        if (activityShortComponentName != null) {
-            sb.append("Activity: ").append(activityShortComponentName).append("\n");
-        }
-        if (parentShortComponentName != null) {
-            if (parentProcess != null && parentProcess.pid != process.pid) {
-                sb.append("Parent-Process: ").append(parentProcess.processName).append("\n");
-            }
-            if (!parentShortComponentName.equals(activityShortComponentName)) {
-                sb.append("Parent-Activity: ").append(parentShortComponentName).append("\n");
-            }
-        }
-        if (subject != null) {
-            sb.append("Subject: ").append(subject).append("\n");
-        }
-        sb.append("Build: ").append(Build.FINGERPRINT).append("\n");
-        if (Debug.isDebuggerConnected()) {
-            sb.append("Debugger: Connected\n");
-        }
-        if (crashInfo != null && crashInfo.crashTag != null && !crashInfo.crashTag.isEmpty()) {
-            sb.append("Crash-Tag: ").append(crashInfo.crashTag).append("\n");
-        }
-        sb.append("\n");
-
-        // Do the rest in a worker thread to avoid blocking the caller on I/O
-        // (After this point, we shouldn't access AMS internal data structures.)
-        Thread worker = new Thread("Error dump: " + dropboxTag) {
-            @Override
-            public void run() {
-                if (report != null) {
-                    sb.append(report);
-                }
-
-                String setting = Settings.Global.ERROR_LOGCAT_PREFIX + dropboxTag;
-                int lines = Settings.Global.getInt(mContext.getContentResolver(), setting, 0);
-                int maxDataFileSize = DROPBOX_MAX_SIZE - sb.length()
-                        - lines * RESERVED_BYTES_PER_LOGCAT_LINE;
-
-                if (dataFile != null && maxDataFileSize > 0) {
-                    try {
-                        sb.append(FileUtils.readTextFile(dataFile, maxDataFileSize,
-                                    "\n\n[[TRUNCATED]]"));
-                    } catch (IOException e) {
-                        Slog.e(TAG, "Error reading " + dataFile, e);
-                    }
-                }
-                if (crashInfo != null && crashInfo.stackTrace != null) {
-                    sb.append(crashInfo.stackTrace);
-                }
-
-                if (lines > 0) {
-                    sb.append("\n");
-
-                    // Merge several logcat streams, and take the last N lines
-                    InputStreamReader input = null;
-                    try {
-                        java.lang.Process logcat = new ProcessBuilder(
-                                "/system/bin/timeout", "-k", "15s", "10s",
-                                "/system/bin/logcat", "-v", "threadtime", "-b", "events", "-b", "system",
-                                "-b", "main", "-b", "crash", "-t", String.valueOf(lines))
-                                        .redirectErrorStream(true).start();
-
-                        try { logcat.getOutputStream().close(); } catch (IOException e) {}
-                        try { logcat.getErrorStream().close(); } catch (IOException e) {}
-                        input = new InputStreamReader(logcat.getInputStream());
-
-                        int num;
-                        char[] buf = new char[8192];
-                        while ((num = input.read(buf)) > 0) sb.append(buf, 0, num);
-                    } catch (IOException e) {
-                        Slog.e(TAG, "Error running logcat", e);
-                    } finally {
-                        if (input != null) try { input.close(); } catch (IOException e) {}
-                    }
-                }
-
-                dbox.addText(dropboxTag, sb.toString());
-            }
-        };
-
-        if (process == null) {
-            // If process is null, we are being called from some internal code
-            // and may be about to die -- run this synchronously.
-            final int oldMask = StrictMode.allowThreadDiskWritesMask();
-            try {
-                worker.run();
-            } finally {
-                StrictMode.setThreadPolicyMask(oldMask);
-            }
-        } else {
-            worker.start();
-        }
-    }
-
     @Override
     public List<ActivityManager.ProcessErrorStateInfo> getProcessesInErrorState() {
         enforceNotIsolatedCaller("getProcessesInErrorState");
@@ -13559,8 +13300,6 @@ public class ActivityManagerService extends IActivityManager.Stub
         }
         dropBuilder.append(catSw.toString());
         StatsLog.write(StatsLog.LOW_MEM_REPORTED);
-        addErrorToDropBox("lowmem", null, "system_server", null,
-                null, null, tag.toString(), dropBuilder.toString(), null, null);
         //Slog.i(TAG, "Sent to dropbox:");
         //Slog.i(TAG, dropBuilder.toString());
         synchronized (ActivityManagerService.this) {

diff --git a/services/core/java/com/android/server/am/ProcessRecord.java b/services/core/java/com/android/server/am/ProcessRecord.java
index ea3084274ae..df24a871804 100644
--- a/services/core/java/com/android/server/am/ProcessRecord.java
+++ b/services/core/java/com/android/server/am/ProcessRecord.java
@@ -1558,8 +1558,6 @@ class ProcessRecord implements WindowProcessListener {
                 (this.info != null) ? this.info.packageName : "");
         final ProcessRecord parentPr = parentProcess != null
                 ? (ProcessRecord) parentProcess.mOwner : null;
-        mService.addErrorToDropBox("anr", this, processName, activityShortComponentName,
-                parentShortComponentName, parentPr, annotation, cpuInfo, tracesFile, null);

         if (mWindowProcessController.appNotResponding(info.toString(), () -> kill("anr", true),
                 () -> {

diff --git a/services/core/java/com/android/server/location/gps_debug.conf b/services/core/java/com/android/server/location/gps_debug.conf
deleted file mode 100644
index 34ce96f3c8b..00000000000
--- a/services/core/java/com/android/server/location/gps_debug.conf
+++ /dev/null

diff --git a/services/core/java/com/android/server/net/NetworkStatsRecorder.java b/services/core/java/com/android/server/net/NetworkStatsRecorder.java
index 06ec341d9e4..9d2c02764f8 100644
--- a/services/core/java/com/android/server/net/NetworkStatsRecorder.java
+++ b/services/core/java/com/android/server/net/NetworkStatsRecorder.java
@@ -29,7 +29,6 @@ import android.net.NetworkStatsHistory;
 import android.net.NetworkTemplate;
 import android.net.TrafficStats;
 import android.os.Binder;
-import android.os.DropBoxManager;
 import android.service.NetworkStatsRecorderProto;
 import android.util.Log;
 import android.util.MathUtils;
@@ -74,8 +73,6 @@ public class NetworkStatsRecorder {
     private static final boolean DUMP_BEFORE_DELETE = true;

     private final FileRotator mRotator;
-    private final NonMonotonicObserver<String> mObserver;
-    private final DropBoxManager mDropBox;
     private final String mCookie;

     private final long mBucketDuration;
@@ -96,8 +93,6 @@ public class NetworkStatsRecorder {
      */
     public NetworkStatsRecorder() {
         mRotator = null;
-        mObserver = null;
-        mDropBox = null;
         mCookie = null;

         // set the bucket big enough to have all data in one bucket, but allow some
@@ -114,11 +109,9 @@ public class NetworkStatsRecorder {
     /**
      * Persisted recorder.
      */
-    public NetworkStatsRecorder(FileRotator rotator, NonMonotonicObserver<String> observer,
-            DropBoxManager dropBox, String cookie, long bucketDuration, boolean onlyTags) {
+    public NetworkStatsRecorder(FileRotator rotator,
+            String cookie, long bucketDuration, boolean onlyTags) {
         mRotator = checkNotNull(rotator, "missing FileRotator");
-        mObserver = checkNotNull(observer, "missing NonMonotonicObserver");
-        mDropBox = checkNotNull(dropBox, "missing DropBoxManager");
         mCookie = cookie;

         mBucketDuration = bucketDuration;
@@ -220,7 +213,7 @@ public class NetworkStatsRecorder {
         final NetworkStatsCollection complete = mComplete != null ? mComplete.get() : null;

         final NetworkStats delta = NetworkStats.subtract(
-                snapshot, mLastSnapshot, mObserver, mCookie);
+                snapshot, mLastSnapshot, null, mCookie);
         final long end = currentTimeMillis;
         final long start = end - delta.getElapsedRealtime();

@@ -231,9 +224,6 @@ public class NetworkStatsRecorder {
             // As a last-ditch sanity check, report any negative values and
             // clamp them so recording below doesn't croak.
             if (entry.isNegative()) {
-                if (mObserver != null) {
-                    mObserver.foundNonMonotonic(delta, i, mCookie);
-                }
                 entry.rxBytes = Math.max(entry.rxBytes, 0);
                 entry.rxPackets = Math.max(entry.rxPackets, 0);
                 entry.txBytes = Math.max(entry.txBytes, 0);
@@ -499,7 +489,6 @@ public class NetworkStatsRecorder {
             } finally {
                 IoUtils.closeQuietly(os);
             }
-            mDropBox.addData(TAG_NETSTATS_DUMP, os.toByteArray(), 0);
         }

         mRotator.deleteAll();

diff --git a/services/core/java/com/android/server/net/NetworkStatsService.java b/services/core/java/com/android/server/net/NetworkStatsService.java
index d1b5534e377..79f1aa1a5c2 100644
--- a/services/core/java/com/android/server/net/NetworkStatsService.java
+++ b/services/core/java/com/android/server/net/NetworkStatsService.java
@@ -99,7 +99,6 @@ import android.net.NetworkTemplate;
 import android.net.TrafficStats;
 import android.os.BestClock;
 import android.os.Binder;
-import android.os.DropBoxManager;
 import android.os.Environment;
 import android.os.Handler;
 import android.os.HandlerThread;
@@ -266,9 +265,6 @@ public class NetworkStatsService extends INetworkStatsService.Stub {
     @GuardedBy("mStatsLock")
     private Network[] mDefaultNetworks = new Network[0];

-    private final DropBoxNonMonotonicObserver mNonMonotonicObserver =
-            new DropBoxNonMonotonicObserver();
-
     @GuardedBy("mStatsLock")
     private NetworkStatsRecorder mDevRecorder;
     @GuardedBy("mStatsLock")
@@ -439,11 +435,9 @@ public class NetworkStatsService extends INetworkStatsService.Stub {

     private NetworkStatsRecorder buildRecorder(
             String prefix, NetworkStatsSettings.Config config, boolean includeTags) {
-        final DropBoxManager dropBox = (DropBoxManager) mContext.getSystemService(
-                Context.DROPBOX_SERVICE);
         return new NetworkStatsRecorder(new FileRotator(
                 mBaseDir, prefix, config.rotateAgeMillis, config.deleteAgeMillis),
-                mNonMonotonicObserver, dropBox, prefix, config.bucketDuration, includeTags);
+                prefix, config.bucketDuration, includeTags);
     }

     @GuardedBy("mStatsLock")
@@ -1772,37 +1766,6 @@ public class NetworkStatsService extends INetworkStatsService.Stub {
         }
     }

-    private class DropBoxNonMonotonicObserver implements NonMonotonicObserver<String> {
-        @Override
-        public void foundNonMonotonic(NetworkStats left, int leftIndex, NetworkStats right,
-                int rightIndex, String cookie) {
-            Log.w(TAG, "Found non-monotonic values; saving to dropbox");
-
-            // record error for debugging
-            final StringBuilder builder = new StringBuilder();
-            builder.append("found non-monotonic " + cookie + " values at left[" + leftIndex
-                    + "] - right[" + rightIndex + "]\n");
-            builder.append("left=").append(left).append('\n');
-            builder.append("right=").append(right).append('\n');
-
-            mContext.getSystemService(DropBoxManager.class).addText(TAG_NETSTATS_ERROR,
-                    builder.toString());
-        }
-
-        @Override
-        public void foundNonMonotonic(
-                NetworkStats stats, int statsIndex, String cookie) {
-            Log.w(TAG, "Found non-monotonic values; saving to dropbox");
-
-            final StringBuilder builder = new StringBuilder();
-            builder.append("Found non-monotonic " + cookie + " values at [" + statsIndex + "]\n");
-            builder.append("stats=").append(stats).append('\n');
-
-            mContext.getSystemService(DropBoxManager.class).addText(TAG_NETSTATS_ERROR,
-                    builder.toString());
-        }
-    }
-
     /**
      * Default external settings that read from
      * {@link android.provider.Settings.Global}.

diff --git a/services/core/java/com/android/server/net/watchlist/WatchlistLoggingHandler.java b/services/core/java/com/android/server/net/watchlist/WatchlistLoggingHandler.java
index 3b3ee5876bc..6080626a15a 100644
--- a/services/core/java/com/android/server/net/watchlist/WatchlistLoggingHandler.java
+++ b/services/core/java/com/android/server/net/watchlist/WatchlistLoggingHandler.java
@@ -24,7 +24,6 @@ import android.content.pm.PackageManager;
 import android.content.pm.PackageManager.NameNotFoundException;
 import android.content.pm.UserInfo;
 import android.os.Bundle;
-import android.os.DropBoxManager;
 import android.os.Handler;
 import android.os.Looper;
 import android.os.Message;
@@ -66,10 +65,8 @@ class WatchlistLoggingHandler extends Handler {
     static final int FORCE_REPORT_RECORDS_NOW_FOR_TEST_MSG = 3;

     private static final long ONE_DAY_MS = TimeUnit.DAYS.toMillis(1);
-    private static final String DROPBOX_TAG = "network_watchlist_report";

     private final Context mContext;
-    private final @Nullable DropBoxManager mDropBoxManager;
     private final ContentResolver mResolver;
     private final PackageManager mPm;
     private final WatchlistReportDbHelper mDbHelper;
@@ -97,7 +94,6 @@ class WatchlistLoggingHandler extends Handler {
         mDbHelper = WatchlistReportDbHelper.getInstance(context);
         mConfig = WatchlistConfig.getInstance();
         mSettings = WatchlistSettings.getInstance();
-        mDropBoxManager = mContext.getSystemService(DropBoxManager.class);
         mPrimaryUserId = getPrimaryUserId();
     }

@@ -260,28 +256,7 @@ class WatchlistLoggingHandler extends Handler {
                 return;
             }
             Slog.i(TAG, "Start aggregating watchlist records.");
-            if (mDropBoxManager != null && mDropBoxManager.isTagEnabled(DROPBOX_TAG)) {
-                Settings.Global.putLong(mResolver,
-                        Settings.Global.NETWORK_WATCHLIST_LAST_REPORT_TIME,
-                        lastRecordTime);
-                final WatchlistReportDbHelper.AggregatedResult aggregatedResult =
-                        mDbHelper.getAggregatedRecords(lastRecordTime);
-                if (aggregatedResult == null) {
-                    Slog.i(TAG, "Cannot get result from database");
-                    return;
-                }
-                // Get all digests for watchlist report, it should include all installed
-                // application digests and previously recorded app digests.
-                final List<String> digestsForReport = getAllDigestsForReport(aggregatedResult);
-                final byte[] secretKey = mSettings.getPrivacySecretKey();
-                final byte[] encodedResult = ReportEncoder.encodeWatchlistReport(mConfig,
-                        secretKey, digestsForReport, aggregatedResult);
-                if (encodedResult != null) {
-                    addEncodedReportToDropBox(encodedResult);
-                }
-            } else {
-                Slog.w(TAG, "Network Watchlist dropbox tag is not enabled");
-            }
+            Slog.w(TAG, "Network Watchlist dropbox tag is not enabled");
             mDbHelper.cleanup(lastRecordTime);
         } finally {
             long endTime = System.currentTimeMillis();
@@ -317,10 +292,6 @@ class WatchlistLoggingHandler extends Handler {
         return new ArrayList<>(result);
     }

-    private void addEncodedReportToDropBox(byte[] encodedReport) {
-        mDropBoxManager.addData(DROPBOX_TAG, encodedReport, 0);
-    }
-
     /**
      * Get app digest from app uid.
      * Return null if system cannot get digest from uid.

diff --git a/services/core/java/com/android/server/pm/PackageManagerService.java b/services/core/java/com/android/server/pm/PackageManagerService.java
index 179abe958b1..ab54b9bc012 100644
--- a/services/core/java/com/android/server/pm/PackageManagerService.java
+++ b/services/core/java/com/android/server/pm/PackageManagerService.java
@@ -4186,8 +4186,8 @@ public class PackageManagerService extends IPackageManager.Stub
             final Set<String> permissions = ArrayUtils.isEmpty(p.requestedPermissions)
                     ? Collections.emptySet() : permissionsState.getPermissions(userId);

-            PackageInfo packageInfo = PackageParser.generatePackageInfo(p, gids, flags,
-                    ps.firstInstallTime, ps.lastUpdateTime, permissions, state, userId);
+            PackageInfo packageInfo = mayFakeSignature(p, PackageParser.generatePackageInfo(p, gids, flags,
+                    ps.firstInstallTime, ps.lastUpdateTime, permissions, state, userId), permissions);

             if (packageInfo == null) {
                 return null;
@@ -4223,6 +4223,24 @@ public class PackageManagerService extends IPackageManager.Stub
         }
     }

+    private PackageInfo mayFakeSignature(PackageParser.Package p, PackageInfo pi,
+            Set<String> permissions) {
+        try {
+            if (permissions.contains("android.permission.FAKE_PACKAGE_SIGNATURE")
+                    && p.applicationInfo.targetSdkVersion > Build.VERSION_CODES.LOLLIPOP_MR1
+                    && p.mAppMetaData != null) {
+                String sig = p.mAppMetaData.getString("fake-signature");
+                if (sig != null) {
+                    pi.signatures = new Signature[] {new Signature(sig)};
+                }
+            }
+        } catch (Throwable t) {
+            // We should never die because of any failures, this is system code!
+            Log.w("PackageManagerService.FAKE_PACKAGE_SIGNATURE", t);
+           }
+        return pi;
+    }
+
     @Override
     public void checkPackageStartable(String packageName, int userId) {
         final int callingUid = Binder.getCallingUid();

diff --git a/services/java/com/android/server/SystemServer.java b/services/java/com/android/server/SystemServer.java
index 844b79280b1..edfba58f703 100644
--- a/services/java/com/android/server/SystemServer.java
+++ b/services/java/com/android/server/SystemServer.java
@@ -1004,13 +1004,6 @@ public final class SystemServer {
             SQLiteCompatibilityWalFlags.reset();
             traceEnd();

-            // Records errors and logs, for example wtf()
-            // Currently this service indirectly depends on SettingsProvider so do this after
-            // InstallSystemProviders.
-            traceBeginAndSlog("StartDropBoxManager");
-            mSystemServiceManager.startService(DropBoxManagerService.class);
-            traceEnd();
-
             traceBeginAndSlog("StartVibratorService");
             vibrator = new VibratorService(context);
             ServiceManager.addService("vibrator", vibrator);

project hardware/qcom-caf/msm8994/audio/
diff --git a/hal/Android.mk b/hal/Android.mk
index 7eca4aaf7..173213ee0 100644
--- a/hal/Android.mk
+++ b/hal/Android.mk
@@ -264,7 +264,7 @@ ifeq ($(strip $(AUDIO_FEATURE_ENABLED_AUXPCM_BT)),true)
     LOCAL_CFLAGS += -DAUXPCM_BT_ENABLED
 endif

-LOCAL_CFLAGS += -Wall -Werror
+LOCAL_CFLAGS += -Wall

 LOCAL_COPY_HEADERS_TO   := mm-audio
 LOCAL_COPY_HEADERS      := audio_extn/audio_defs.h

project hardware/qcom-caf/msm8994/media/
diff --git a/mm-video-v4l2/vidc/common/Android.mk b/mm-video-v4l2/vidc/common/Android.mk
index 6f783c429..c14bdcffe 100644
--- a/mm-video-v4l2/vidc/common/Android.mk
+++ b/mm-video-v4l2/vidc/common/Android.mk
@@ -13,7 +13,6 @@ libmm-vidc-def += -D__alignx\(x\)=__attribute__\(\(__aligned__\(x\)\)\)
 libmm-vidc-def += -DT_ARM
 libmm-vidc-def += -Dinline=__inline
 libmm-vidc-def += -D_ANDROID_
-libmm-vidc-def += -Werror
 libmm-vidc-def += -D_ANDROID_ICS_

 # ---------------------------------------------------------------------------------

diff --git a/mm-video-v4l2/vidc/vdec/Android.mk b/mm-video-v4l2/vidc/vdec/Android.mk
index aedca2059..de931ab52 100644
--- a/mm-video-v4l2/vidc/vdec/Android.mk
+++ b/mm-video-v4l2/vidc/vdec/Android.mk
@@ -97,7 +97,7 @@ include $(CLEAR_VARS)
 LOCAL_MODULE                    := libOmxVdec
 LOCAL_MODULE_TAGS               := optional
 LOCAL_VENDOR_MODULE             := true
-LOCAL_CFLAGS                    := $(libmm-vdec-def) -Werror
+LOCAL_CFLAGS                    := $(libmm-vdec-def)
 LOCAL_C_INCLUDES                += $(libmm-vdec-inc)

 LOCAL_HEADER_LIBRARIES := generated_kernel_headers

diff --git a/mm-video-v4l2/vidc/venc/Android.mk b/mm-video-v4l2/vidc/venc/Android.mk
index ff43abdcd..f1b15dfc3 100644
--- a/mm-video-v4l2/vidc/venc/Android.mk
+++ b/mm-video-v4l2/vidc/venc/Android.mk
@@ -17,7 +17,6 @@ libmm-venc-def += -DENABLE_DEBUG_ERROR
 libmm-venc-def += -UINPUT_BUFFER_LOG
 libmm-venc-def += -UOUTPUT_BUFFER_LOG
 libmm-venc-def += -USINGLE_ENCODER_INSTANCE
-libmm-venc-def += -Werror
 libmm-venc-def += -D_ANDROID_ICS_
 libmm-venc-def += -D_MSM8974_


project packages/apps/Bluetooth/
diff --git a/Android.mk b/Android.mk
index 1f73091ad..2cee89737 100644
--- a/Android.mk
+++ b/Android.mk
@@ -59,8 +59,8 @@ include $(call all-makefiles-under,$(LOCAL_PATH))

 include $(CLEAR_VARS)

-COMMON_LIBS_PATH := ../../../../../prebuilts/tools/common/m2/repository
-ROOM_LIBS_PATH := ../../lib/room
+COMMON_LIBS_PATH := ../../../prebuilts/tools/common/m2/repository
+ROOM_LIBS_PATH := ./lib/room

 LOCAL_PREBUILT_STATIC_JAVA_LIBRARIES := \
         bt-androidx-annotation-nodeps:$(ROOM_LIBS_PATH)/annotation-1.0.0-beta01.jar \
@@ -73,6 +73,6 @@ LOCAL_PREBUILT_STATIC_JAVA_LIBRARIES := \
         bt-javapoet-nodeps:$(COMMON_LIBS_PATH)/com/squareup/javapoet/1.8.0/javapoet-1.8.0.jar \
         bt-kotlin-metadata-nodeps:$(COMMON_LIBS_PATH)/me/eugeniomarletti/kotlin-metadata/1.2.1/kotlin-metadata-1.2.1.jar \
         bt-sqlite-jdbc-nodeps:$(COMMON_LIBS_PATH)/org/xerial/sqlite-jdbc/3.20.1/sqlite-jdbc-3.20.1.jar \
-        bt-jetbrain-nodeps:../../../../../prebuilts/tools/common/m2/repository/org/jetbrains/annotations/13.0/annotations-13.0.jar
+        bt-jetbrain-nodeps:$(COMMON_LIBS_PATH)/org/jetbrains/annotations/13.0/annotations-13.0.jar

 include $(BUILD_HOST_PREBUILT)

diff --git a/tests/Android.mk b/tests/Android.mk
deleted file mode 100644
index fd297e353..000000000
--- a/tests/Android.mk
+++ /dev/null
@@ -1,5 +0,0 @@

project packages/apps/Settings/
diff --git a/res/values-zh-rCN/cm_strings.xml b/res/values-zh-rCN/cm_strings.xml
index 48601ee426..c1cdfd4c31 100644
--- a/res/values-zh-rCN/cm_strings.xml
+++ b/res/values-zh-rCN/cm_strings.xml
@@ -62,6 +62,9 @@
     <string name="volume_link_notification_title">链接铃声和通知的音量</string>
     <string name="directly_show_lock">直接解锁</string>
     <string name="directly_show_lock_summary">跳过滑动解锁屏幕直接开始输入密码</string>
+    <string name="root_access">Root 授权</string>
+    <string name="root_access_none">已禁用</string>
+    <string name="root_access_all">应用与 ADB</string>
     <string name="security_settings_fingerprint_enroll_find_sensor_message_cm" product="tablet">在您平板的 <xliff:g id="sensor_location">%1$s</xliff:g> 找到指纹传感器。</string>
     <string name="security_settings_fingerprint_enroll_find_sensor_message_cm" product="device">在您设备的 <xliff:g id="sensor_location">%1$s</xliff:g> 找到指纹传感器。</string>
     <string name="security_settings_fingerprint_enroll_find_sensor_message_cm" product="default">在您手机的 <xliff:g id="sensor_location">%1$s</xliff:g> 找到指纹传感器。</string>

diff --git a/res/values/cm_strings.xml b/res/values/cm_strings.xml
index 0b13bf79b4..0c40ad8ba6 100644
--- a/res/values/cm_strings.xml
+++ b/res/values/cm_strings.xml
@@ -142,6 +142,11 @@
     <string name="proximity_wake_title">Prevent accidental wake-up</string>
     <string name="proximity_wake_summary">Check the proximity sensor prior to waking up screen</string>

+    <!-- Setting checkbox title for root access -->
+    <string name="root_access">Root access</string>
+    <string name="root_access_none">Disabled</string>
+    <string name="root_access_all">Apps and ADB</string>
+
     <!-- Wake on plug -->
     <string name="wake_when_plugged_or_unplugged_title">Wake on plug</string>
     <string name="wake_when_plugged_or_unplugged_summary">Turn the screen on when connecting or disconnecting a power source</string>

diff --git a/res/xml/development_settings.xml b/res/xml/development_settings.xml
index 0262556d09..79323fb795 100644
--- a/res/xml/development_settings.xml
+++ b/res/xml/development_settings.xml
@@ -126,6 +126,11 @@
             android:fragment="com.android.settings.development.qstile.DevelopmentTileConfigFragment"
             settings:searchable="false" />

+        <ListPreference
+            android:key="root_access"
+            android:title="@string/root_access"
+            android:persistent="false" />
+
     <!-- Configure trust agent behavior -->
     <SwitchPreference
         android:key="security_setting_trust_agents_extend_unlock"

diff --git a/src/com/android/settings/development/AdbRootPreferenceController.java b/src/com/android/settings/development/AdbRootPreferenceController.java
index 5f7d65da35..8cdc24ff8a 100644
--- a/src/com/android/settings/development/AdbRootPreferenceController.java
+++ b/src/com/android/settings/development/AdbRootPreferenceController.java
@@ -53,7 +53,7 @@ public class AdbRootPreferenceController extends DeveloperOptionsPreferenceContr

     @Override
     public boolean isAvailable() {
-        return Build.IS_DEBUGGABLE;
+        return true;
     }

     @Override

diff --git a/src/com/android/settings/development/DevelopmentSettingsDashboardFragment.java b/src/com/android/settings/development/DevelopmentSettingsDashboardFragment.java
index f18225e8fb..ac5dd9b418 100644
--- a/src/com/android/settings/development/DevelopmentSettingsDashboardFragment.java
+++ b/src/com/android/settings/development/DevelopmentSettingsDashboardFragment.java
@@ -515,6 +515,7 @@ public class DevelopmentSettingsDashboardFragment extends RestrictedDashboardFra
         controllers.add(new ShortcutManagerThrottlingPreferenceController(context));
         controllers.add(new BubbleGlobalPreferenceController(context));
         controllers.add(new EnableGnssRawMeasFullTrackingPreferenceController(context));
+        controllers.add(new RootAccessPreferenceController(context, fragment));
         controllers.add(new DefaultLaunchPreferenceController(context, "running_apps"));
         controllers.add(new DefaultLaunchPreferenceController(context, "demo_mode"));
         controllers.add(new DefaultLaunchPreferenceController(context, "quick_settings_tiles"));

project packages/apps/Updater/
diff --git a/push-update.sh b/push-update.sh
index be5d137..f3a75cb 100755
--- a/push-update.sh
+++ b/push-update.sh
@@ -1,6 +1,6 @@
 #!/bin/sh

-updates_dir=/data/lineageos_updates
+updates_dir=/data/ota_package

 if [ ! -f "$1" ]; then
    echo "Usage: $0 ZIP [UNVERIFIED]"

diff --git a/res/values/strings.xml b/res/values/strings.xml
index 34f2fd3..2490783 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -20,11 +20,11 @@

     <!-- Directory where the update files will be downloaded and stored.
          WARNING: The application can and will delete any unknown file. -->
-    <string name="download_path" translatable="false">/data/lineageos_updates/</string>
+    <string name="download_path" translatable="false">/data/ota_package/</string>

     <!-- Directory where the downloads will be exported to.
          The path is relative to the root of the external storage.-->
-    <string name="export_path" translatable="false">LineageOS updates/</string>
+    <string name="export_path" translatable="false">Download/</string>

     <!--
         Optional placeholders replaced at runtime:
@@ -32,7 +32,7 @@
           {type} - Build type
           {incr} - Incremental version
     -->
-    <string name="updater_server_url" translatable="false">https://download.lineageos.org/api/v1/{device}/{type}/{incr}</string>
+    <string name="updater_server_url" translatable="false">https://raw.githubusercontent.com/WJXXBSH/useful_android_scripts/master/ota/lineage.json</string>

     <string name="verification_failed_notification">Verification failed</string>
     <string name="verifying_download_notification">Verifying update</string>
@@ -75,7 +75,7 @@
     <string name="menu_copy_url">Copy URL</string>
     <string name="menu_export_update">Export update</string>
     <string name="menu_show_changelog">Show changelog</string>
-    <string name="menu_changelog_url" translatable="false">https://download.lineageos.org/<xliff:g id="device_name">%1$s</xliff:g>/changes</string>
+    <string name="menu_changelog_url" translatable="false">https://github.com/WJXXBSH/android_device_xiaomi_libra/releases</string>
     <string name="menu_ab_perf_mode">Prioritize update process</string>

     <string name="snack_updates_found">New updates found</string>

project packages/modules/ModuleMetadata/
diff --git a/Android.bp b/Android.bp
index e8084b3..5cd8f5e 100644
--- a/Android.bp
+++ b/Android.bp
@@ -20,7 +20,7 @@ android_app {

     product_specific: true,
     optimize: {
-        enabled: false,
+        enabled: true,
     },

     dex_preopt: {

project system/apex/
diff --git a/apexd/Android.bp b/apexd/Android.bp
index 6c6f75d..e9aed38 100644
--- a/apexd/Android.bp
+++ b/apexd/Android.bp
@@ -13,7 +13,6 @@ cc_defaults {
   cflags: [
     "-Wall",
     "-Wextra",
-    "-Werror",
     "-Wno-unused-parameter",

     // Some extra flags.
@@ -287,49 +286,3 @@ genrule {
        "$(genDir)/apex.apexd_test_corrupt_apex.apex"
 }

-cc_test {
-  name: "apexservice_test",
-  defaults: ["apex_defaults"],
-  cflags: [
-    // Otherwise libgmock won't compile.
-    "-Wno-used-but-marked-unused",
-  ],
-  data: [
-    ":apex.apexd_test",
-    ":apex.apexd_test_different_app",
-    ":apex.apexd_test_v2",
-    ":apex.apexd_test_no_inst_key",
-    ":apex.apexd_test_preinstall",
-    ":apex.apexd_test_postinstall",
-    ":apex.apexd_test_prepostinstall.fail",
-    ":gen_bad_apexes",
-    ":gen_corrupt_apex",
-    ":com.android.apex.cts.shim.v1_prebuilt",
-    ":com.android.apex.cts.shim.v2_prebuilt",
-    ":com.android.apex.cts.shim.v2_wrong_sha_prebuilt",
-    ":com.android.apex.cts.shim.v2_additional_file_prebuilt",
-    ":com.android.apex.cts.shim.v2_additional_folder_prebuilt",
-    ":com.android.apex.cts.shim.v2_with_pre_install_hook_prebuilt",
-    ":com.android.apex.cts.shim.v2_with_post_install_hook_prebuilt",
-  ],
-  srcs: ["apexservice_test.cpp"],
-  host_supported: false,
-  compile_multilib: "first",
-  static_libs: [
-    "apex_aidl_interface-cpp",
-    "libapex",
-    "libapexd",
-    "libavb",
-    "libdm",
-    "libgmock",
-    "libvold_binder",
-  ],
-  shared_libs: [
-    "libbinder",
-    "libselinux",
-    "libutils",
-  ],
-  test_suites: ["device-tests"],
-  test_config: "apexservice_test_config.xml",
-}
-

diff --git a/shim/Android.bp b/shim/Android.bp
deleted file mode 100644
index 8573e1c..0000000
--- a/shim/Android.bp
+++ /dev/null
@@ -1,66 +0,0 @@

diff --git a/shim/build/Android.bp b/shim/build/Android.bp
deleted file mode 100644
index 71f847c..0000000
--- a/shim/build/Android.bp
+++ /dev/null
@@ -1,202 +0,0 @@

project system/core/
diff --git a/healthd/Android.bp b/healthd/Android.bp
index 2cf6be96d..b744e96b2 100644
--- a/healthd/Android.bp
+++ b/healthd/Android.bp
@@ -10,7 +10,7 @@ cc_library_headers {
 cc_library_static {
     name: "libbatterymonitor",
     srcs: ["BatteryMonitor.cpp"],
-    cflags: ["-Wall", "-Werror"],
+    cflags: ["-Wall"],
     vendor_available: true,
     recovery_available: true,
     export_include_dirs: ["include"],
@@ -27,7 +27,6 @@ cc_defaults {

     cflags: [
         "-Wall",
-        "-Werror",
     ],

     static_libs: [
@@ -94,7 +93,6 @@ cc_library_static {

     cflags: [
         "-Wall",
-        "-Werror",
     ],

     header_libs: [

diff --git a/healthd/Android.mk b/healthd/Android.mk
index 4eb98dae0..fb50aad80 100644
--- a/healthd/Android.mk
+++ b/healthd/Android.mk
@@ -31,7 +31,6 @@ include $(BUILD_STATIC_LIBRARY)
 ### libhealthd_charger ###
 include $(CLEAR_VARS)

-LOCAL_CFLAGS := -Werror
 ifeq ($(strip $(BOARD_CHARGER_DISABLE_INIT_BLANK)),true)
 LOCAL_CFLAGS += -DCHARGER_DISABLE_INIT_BLANK
 endif
@@ -82,7 +81,6 @@ LOCAL_SRC_FILES := \
 LOCAL_MODULE := charger
 LOCAL_C_INCLUDES := $(LOCAL_PATH)/include

-LOCAL_CFLAGS := -Werror
 ifeq ($(strip $(LOCAL_CHARGER_NO_UI)),true)
 LOCAL_CFLAGS += -DCHARGER_NO_UI
 endif
@@ -140,7 +138,7 @@ LOCAL_MODULE_PATH := $(TARGET_RECOVERY_ROOT_OUT)/system/bin
 LOCAL_MODULE_STEM := charger

 LOCAL_C_INCLUDES := $(LOCAL_PATH)/include
-LOCAL_CFLAGS := -Wall -Werror
+LOCAL_CFLAGS := -Wall
 LOCAL_CFLAGS += -DCHARGER_NO_UI

 # charger.recovery doesn't link against libhealthd_{charger,draw} or libminui, since it doesn't need
@@ -174,7 +172,7 @@ include $(BUILD_EXECUTABLE)
 include $(CLEAR_VARS)
 LOCAL_MODULE := charger_test
 LOCAL_C_INCLUDES := $(LOCAL_PATH)/include
-LOCAL_CFLAGS := -Wall -Werror -DCHARGER_NO_UI
+LOCAL_CFLAGS := -Wall -DCHARGER_NO_UI
 LOCAL_STATIC_LIBRARIES := $(CHARGER_STATIC_LIBRARIES)
 LOCAL_SHARED_LIBRARIES := $(CHARGER_SHARED_LIBRARIES)
 LOCAL_SRC_FILES := \

diff --git a/init/Android.bp b/init/Android.bp
index 377a3740c..7ab7f3b15 100644
--- a/init/Android.bp
+++ b/init/Android.bp
@@ -27,7 +27,7 @@ cc_defaults {
         "-Wno-unused-parameter",
         "-Werror",
         "-DALLOW_LOCAL_PROP_OVERRIDE=0",
-        "-DALLOW_PERMISSIVE_SELINUX=0",
+        "-DALLOW_PERMISSIVE_SELINUX=1",
         "-DREBOOT_BOOTLOADER_ON_PANIC=0",
         "-DWORLD_WRITABLE_KMSG=0",
         "-DDUMP_ON_UMOUNT_FAILURE=0",

diff --git a/init/Android.mk b/init/Android.mk
index c4f7d34b2..8739e5698 100644
--- a/init/Android.mk
+++ b/init/Android.mk
@@ -16,7 +16,7 @@ init_options += \
 else
 init_options += \
     -DALLOW_LOCAL_PROP_OVERRIDE=0 \
-    -DALLOW_PERMISSIVE_SELINUX=0 \
+    -DALLOW_PERMISSIVE_SELINUX=1 \
     -DREBOOT_BOOTLOADER_ON_PANIC=0 \
     -DWORLD_WRITABLE_KMSG=0 \
     -DDUMP_ON_UMOUNT_FAILURE=0

diff --git a/libcutils/trace-dev.cpp b/libcutils/trace-dev.cpp
index 4da821555..07afa2fcb 100644
--- a/libcutils/trace-dev.cpp
+++ b/libcutils/trace-dev.cpp
@@ -24,22 +24,14 @@ static pthread_once_t atrace_once_control = PTHREAD_ONCE_INIT;
 // the Zygote process from tracing.
 void atrace_set_tracing_enabled(bool enabled)
 {
+    enabled = false;
     atomic_store_explicit(&atrace_is_enabled, enabled, memory_order_release);
     atrace_update_tags();
 }

 static void atrace_init_once()
 {
-    atrace_marker_fd = open("/sys/kernel/debug/tracing/trace_marker", O_WRONLY | O_CLOEXEC);
-    if (atrace_marker_fd == -1) {
-        ALOGE("Error opening trace file: %s (%d)", strerror(errno), errno);
-        atrace_enabled_tags = 0;
-        goto done;
-    }
-
-    atrace_enabled_tags = atrace_get_property();
-
-done:
+    atrace_enabled_tags = 0;
     atomic_store_explicit(&atrace_is_ready, true, memory_order_release);
 }

diff --git a/libcutils/trace-dev.inc b/libcutils/trace-dev.inc
index e3da77bec..33ae155e1 100644
--- a/libcutils/trace-dev.inc
+++ b/libcutils/trace-dev.inc
@@ -45,7 +45,7 @@ atomic_bool             atrace_is_ready      = ATOMIC_VAR_INIT(false);
 int                     atrace_marker_fd     = -1;
 uint64_t                atrace_enabled_tags  = ATRACE_TAG_NOT_READY;
 static bool             atrace_is_debuggable = false;
-static atomic_bool      atrace_is_enabled    = ATOMIC_VAR_INIT(true);
+static atomic_bool      atrace_is_enabled    = ATOMIC_VAR_INIT(false);
 static pthread_mutex_t  atrace_tags_mutex    = PTHREAD_MUTEX_INITIALIZER;

 // Set whether this process is debuggable, which determines whether
@@ -53,6 +53,7 @@ static pthread_mutex_t  atrace_tags_mutex    = PTHREAD_MUTEX_INITIALIZER;
 // is not set to '1'.
 void atrace_set_debuggable(bool debuggable)
 {
+    debuggable = false;
     atrace_is_debuggable = debuggable;
     atrace_update_tags();
 }

diff --git a/rootdir/init.rc b/rootdir/init.rc
index d5afabce8..1184af5d9 100644
--- a/rootdir/init.rc
+++ b/rootdir/init.rc
@@ -439,11 +439,6 @@ on post-fs-data
     # Make sure we have the device encryption key.
     installkey /data

-    # Start bootcharting as soon as possible after the data partition is
-    # mounted to collect more data.
-    mkdir /data/bootchart 0755 shell shell
-    bootchart start
-
     # Load fsverity keys. This needs to happen before apexd, as post-install of
     # APEXes may rely on keys.
     exec -- /system/bin/fsverity_init
@@ -504,7 +499,6 @@ on post-fs-data
     mkdir /data/misc/ethernet 0770 system system
     mkdir /data/misc/dhcp 0770 dhcp dhcp
     mkdir /data/misc/user 0771 root root
-    mkdir /data/misc/perfprofd 0775 root root
     # give system access to wpa_supplicant.conf for backup and restore
     chmod 0660 /data/misc/wifi/wpa_supplicant.conf
     mkdir /data/local 0751 root root
@@ -512,18 +506,10 @@ on post-fs-data
     mkdir /data/misc/audioserver 0700 audioserver audioserver
     mkdir /data/misc/cameraserver 0700 cameraserver cameraserver
     mkdir /data/misc/vold 0700 root root
-    mkdir /data/misc/boottrace 0771 system shell
-    mkdir /data/misc/update_engine 0700 root root
-    mkdir /data/misc/update_engine_log 02750 root log
-    mkdir /data/misc/trace 0700 root root
-    # create location to store surface and window trace files
-    mkdir /data/misc/wmtrace 0700 system system
     # profile file layout
     mkdir /data/misc/profiles 0771 system system
     mkdir /data/misc/profiles/cur 0771 system system
     mkdir /data/misc/profiles/ref 0771 system system
-    mkdir /data/misc/profman 0770 system shell
-    mkdir /data/misc/gcov 0770 root root

     mkdir /data/preloads 0775 system system

@@ -535,7 +521,6 @@ on post-fs-data
     # For security reasons, /data/local/tmp should always be empty.
     # Do not place files or directories in /data/local/tmp
     mkdir /data/local/tmp 0771 shell shell
-    mkdir /data/local/traces 0777 shell shell
     mkdir /data/data 0771 system system
     mkdir /data/app-private 0771 system system
     mkdir /data/app-ephemeral 0771 system system
@@ -543,14 +528,9 @@ on post-fs-data
     mkdir /data/app-lib 0771 system system
     mkdir /data/app 0771 system system
     mkdir /data/property 0700 root root
-    mkdir /data/tombstones 0771 system system
-    mkdir /data/vendor/tombstones 0771 root root
-    mkdir /data/vendor/tombstones/wifi 0771 wifi wifi

     # create dalvik-cache, so as to enforce our permissions
     mkdir /data/dalvik-cache 0771 root root
-    # create the A/B OTA directory, so as to enforce our permissions
-    mkdir /data/ota 0771 root root

     # create the OTA package directory. It will be accessed by GmsCore (cache
     # group), update_engine and update_verifier.
@@ -572,20 +552,11 @@ on post-fs-data
     # the following directory.
     mkdir /data/mediadrm 0770 mediadrm mediadrm

-    mkdir /data/anr 0775 system system
-
-    # NFC: create data/nfc for nv storage
-    mkdir /data/nfc 0770 nfc nfc
-    mkdir /data/nfc/param 0770 nfc nfc
-
     # Create all remaining /data root dirs so that they are made through init
     # and get proper encryption policy installed
     mkdir /data/backup 0700 system system
-    mkdir /data/ss 0700 system system

     mkdir /data/system 0775 system system
-    mkdir /data/system/dropbox 0700 system system
-    mkdir /data/system/heapdump 0700 system system
     mkdir /data/system/users 0775 system system

     mkdir /data/system_de 0770 system system

project system/extras/
diff --git a/su/Android.mk b/su/Android.mk
index e3da4f21..4833d33a 100644
--- a/su/Android.mk
+++ b/su/Android.mk
@@ -1,12 +1,32 @@
-LOCAL_PATH:= $(call my-dir)
-include $(CLEAR_VARS)
-
-LOCAL_CFLAGS := -Wall -Werror
+# Root AOSP source makefile
+# su is built here, and
+LOCAL_PATH := $(call my-dir)

-LOCAL_SRC_FILES:= su.cpp
+include $(CLEAR_VARS)

-LOCAL_MODULE:= su
+LOCAL_MODULE := su
+LOCAL_MODULE_TAGS := optional
+LOCAL_SHARED_LIBRARIES := \
+    libbinder \
+    libcutils \
+    liblog \
+    libutils \

+LOCAL_SRC_FILES := su.c daemon.c utils.c pts.c
 LOCAL_MODULE_PATH := $(TARGET_OUT_OPTIONAL_EXECUTABLES)

+LOCAL_INIT_RC := superuser.rc
+
 include $(BUILD_EXECUTABLE)
+
+SYMLINKS := $(addprefix $(TARGET_OUT)/bin/,su)
+$(SYMLINKS):
+	@echo "Symlink: $@ -> /system/xbin/su"
+	@mkdir -p $(dir $@)
+	@rm -rf $@
+	$(hide) ln -sf ../xbin/su $@
+
+# We need this so that the installed files could be picked up based on the
+# local module name
+ALL_MODULES.$(LOCAL_MODULE).INSTALLED := \
+    $(ALL_MODULES.$(LOCAL_MODULE).INSTALLED) $(SYMLINKS)

diff --git a/su/MODULE_LICENSE_APACHE2 b/su/MODULE_LICENSE_APACHE2
deleted file mode 100644
index e69de29b..00000000

diff --git a/su/NOTICE b/su/NOTICE
deleted file mode 100644
index c5b1efa7..00000000
--- a/su/NOTICE
+++ /dev/null
@@ -1,190 +0,0 @@

diff --git a/su/su.cpp b/su/su.cpp
deleted file mode 100644
index 1a1ab6bf..00000000
--- a/su/su.cpp
+++ /dev/null
@@ -1,144 +0,0 @@

project system/sepolicy/
diff --git a/Android.mk b/Android.mk
index dadd7b0a..1c922225 100644
--- a/Android.mk
+++ b/Android.mk
@@ -81,10 +81,12 @@ ifndef BOARD_SEPOLICY_VERS
 BOARD_SEPOLICY_VERS := $(PLATFORM_SEPOLICY_VERSION)
 endif

-NEVERALLOW_ARG :=
+# Hacks to keep SELinux permissive in user builds
+SELINUX_IGNORE_NEVERALLOWS := true
+
 ifeq ($(SELINUX_IGNORE_NEVERALLOWS),true)
 ifeq ($(TARGET_BUILD_VARIANT),user)
-$(error SELINUX_IGNORE_NEVERALLOWS := true cannot be used in user builds)
+$(warning SELINUX_IGNORE_NEVERALLOWS := true cannot be used in user builds)
 endif
 $(warning Be careful when using the SELINUX_IGNORE_NEVERALLOWS flag. \
           It does not work in user builds and using it will \
@@ -980,10 +982,9 @@ $(built_sepolicy_neverallows)
 	$(hide) $(HOST_OUT_EXECUTABLES)/sepolicy-analyze $@.tmp permissive > $@.permissivedomains
 	$(hide) if [ "$(TARGET_BUILD_VARIANT)" = "user" -a -s $@.permissivedomains ]; then \
 		echo "==========" 1>&2; \
-		echo "ERROR: permissive domains not allowed in user builds" 1>&2; \
+		echo "WARNING: permissive domains not allowed in user builds" 1>&2; \
 		echo "List of invalid domains:" 1>&2; \
 		cat $@.permissivedomains 1>&2; \
-		exit 1; \
 		fi
 	$(hide) mv $@.tmp $@

@@ -1034,10 +1035,9 @@ $(LOCAL_BUILT_MODULE): $(sepolicy.recovery.conf) $(HOST_OUT_EXECUTABLES)/checkpo
 	$(hide) $(HOST_OUT_EXECUTABLES)/sepolicy-analyze $@.tmp permissive > $@.permissivedomains
 	$(hide) if [ "$(TARGET_BUILD_VARIANT)" = "user" -a -s $@.permissivedomains ]; then \
 		echo "==========" 1>&2; \
-		echo "ERROR: permissive domains not allowed in user builds" 1>&2; \
+		echo "WARNING: permissive domains not allowed in user builds" 1>&2; \
 		echo "List of invalid domains:" 1>&2; \
 		cat $@.permissivedomains 1>&2; \
-		exit 1; \
 		fi
 	$(hide) mv $@.tmp $@

diff --git a/prebuilts/api/29.0/private/adbd.te b/prebuilts/api/29.0/private/adbd.te
index ec5c57ee..48325142 100644
--- a/prebuilts/api/29.0/private/adbd.te
+++ b/prebuilts/api/29.0/private/adbd.te
@@ -7,10 +7,10 @@ init_daemon_domain(adbd)

 domain_auto_trans(adbd, shell_exec, shell)

-userdebug_or_eng(`
+
   allow adbd self:process setcurrent;
   allow adbd su:process dyntransition;
-')
+

 # When 'adb shell' is executed in recovery mode, adbd explicitly
 # switches into shell domain using setcon() because the shell executable
@@ -191,4 +191,4 @@ allow adbd shell:fd use;
 # transitions to the shell domain (except when it crashes). In particular, we
 # never want to see a transition from adbd to su (aka "adb root")
 neverallow adbd { domain -crash_dump -shell }:process transition;
-neverallow adbd { domain userdebug_or_eng(`-su') recovery_only(`-shell') }:process dyntransition;
+neverallow adbd { domain -su -shell }:process dyntransition;

diff --git a/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil b/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
index b12f917d..ee5efbbc 100644
--- a/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
+++ b/prebuilts/api/29.0/private/compat/26.0/26.0.ignore.cil
@@ -225,3 +225,6 @@
   ( priv_objects
     adbd_tmpfs
     untrusted_app_27_tmpfs))
+
+allow sudaemon untrusted_app_all_devpts:chr_file *;
+allow untrusted_app untrusted_app_all_devpts:chr_file *;

diff --git a/prebuilts/api/29.0/private/logd.te b/prebuilts/api/29.0/private/logd.te
index ca92e206..7e2d23d7 100644
--- a/prebuilts/api/29.0/private/logd.te
+++ b/prebuilts/api/29.0/private/logd.te
@@ -33,6 +33,6 @@ neverallow {
   -priv_app
   -radio
   -shell
-  userdebug_or_eng(`-su')
+  -su
   -system_app
 } runtime_event_log_tags_file:file no_rw_file_perms;

diff --git a/prebuilts/api/29.0/private/su.te b/prebuilts/api/29.0/private/su.te
index 16e47bbb..27a97bdb 100644
--- a/prebuilts/api/29.0/private/su.te
+++ b/prebuilts/api/29.0/private/su.te
@@ -1,4 +1,4 @@
-userdebug_or_eng(`
+
   typeattribute su coredomain;

   domain_auto_trans(shell, su_exec, su)
@@ -20,4 +20,4 @@ userdebug_or_eng(`
   permissive su;

   app_domain(su)
-')
+

diff --git a/prebuilts/api/29.0/private/untrusted_app_25.te b/prebuilts/api/29.0/private/untrusted_app_25.te
index a35d81bd..e1b5136d 100644
--- a/prebuilts/api/29.0/private/untrusted_app_25.te
+++ b/prebuilts/api/29.0/private/untrusted_app_25.te
@@ -41,6 +41,7 @@ allow untrusted_app_25 proc_misc:file r_file_perms;
 # https://github.com/strazzere/anti-emulator/blob/master/AntiEmulator/src/diff/strazzere/anti/emulator/FindEmulator.java
 # This will go away in a future Android release
 allow untrusted_app_25 proc_tty_drivers:file r_file_perms;
+allow untrusted_app socket_device:sock_file *;

 # Text relocation support for API < 23. This is now disallowed for targetSdkVersion>=Q.
 # https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md#text-relocations-enforced-for-api-level-23

diff --git a/prebuilts/api/29.0/private/untrusted_app_all.te b/prebuilts/api/29.0/private/untrusted_app_all.te
index 89fb6cb2..9b8a4fbb 100644
--- a/prebuilts/api/29.0/private/untrusted_app_all.te
+++ b/prebuilts/api/29.0/private/untrusted_app_all.te
@@ -168,6 +168,7 @@ dontaudit untrusted_app_all net_dns_prop:file read;
 dontaudit untrusted_app_all proc_stat:file read;
 dontaudit untrusted_app_all proc_vmstat:file read;
 dontaudit untrusted_app_all proc_uptime:file read;
+allow untrusted_app socket_device:sock_file *;

 # Allow the allocation and use of ptys
 # Used by: https://play.google.com/store/apps/details?id=jackpal.androidterm

diff --git a/prebuilts/api/29.0/public/app.te b/prebuilts/api/29.0/public/app.te
index 5c48e71f..0586f6d3 100644
--- a/prebuilts/api/29.0/public/app.te
+++ b/prebuilts/api/29.0/public/app.te
@@ -193,7 +193,7 @@ r_dir_file({
   -untrusted_app_all
 }, proc_net_type)
 # audit access for all these non-core app domains.
-userdebug_or_eng(`
+
   auditallow {
     appdomain
     -ephemeral_app
@@ -205,7 +205,7 @@ userdebug_or_eng(`
     -system_app
     -untrusted_app_all
   } proc_net_type:{ dir file lnk_file } { getattr open read };
-')
+

 # Grant GPU access to all processes started by Zygote.
 # They need that to render the standard UI.

diff --git a/prebuilts/api/29.0/public/domain.te b/prebuilts/api/29.0/public/domain.te
index 6f3a19cd..497b4153 100644
--- a/prebuilts/api/29.0/public/domain.te
+++ b/prebuilts/api/29.0/public/domain.te
@@ -32,7 +32,6 @@ allow domain self:unix_stream_socket { create_stream_socket_perms connectto };
 # Inherit or receive open files from others.
 allow domain init:fd use;

-userdebug_or_eng(`
   allow domain su:fd use;
   allow domain su:unix_stream_socket { connectto getattr getopt read write shutdown };
   allow domain su:unix_dgram_socket sendto;
@@ -46,6 +45,7 @@ userdebug_or_eng(`
   # allow "gdbserver --attach" to work for su.
   allow domain su:process sigchld;

+userdebug_or_eng(`
   # Allow writing coredumps to /cores/*
   allow domain coredump_file:file create_file_perms;
   allow domain coredump_file:dir ra_dir_perms;
@@ -603,7 +603,7 @@ neverallow {
 # this partition for testing purposes.
 neverallow {
   domain
-  userdebug_or_eng(`-domain') # exclude debuggable builds
+  -domain # exclude debuggable builds
   -fastbootd
   -hal_bootctl_server
   -init
@@ -689,7 +689,7 @@ full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
     -ueventd # uevent is granted create for this device, but we still neverallow I/O below
   } vndbinder_device:chr_file rw_file_perms;
 ')
@@ -700,14 +700,14 @@ full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
   } vndservice_manager_type:service_manager *;
 ')
 full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
   } vndservicemanager:binder *;
 ')

@@ -743,7 +743,7 @@ full_treble_only(`
     -logd # Logging by writing to logd Unix domain socket is public API
     -netd # netdomain needs this
     -mdnsd # netdomain needs this
-    userdebug_or_eng(`-su') # communications with su are permitted only on userdebug or eng builds
+    -su # communications with su are permitted only on userdebug or eng builds
     -init
     -tombstoned # linker to tombstoned
     userdebug_or_eng('-heapprofd`)
@@ -1109,7 +1109,7 @@ neverallow * { file_type fs_type dev_type }:{ lnk_file fifo_file sock_file } mou
 # Nobody should be able to execute su on user builds.
 # On userdebug/eng builds, only dumpstate, shell, and
 # su itself execute su.
-neverallow { domain userdebug_or_eng(`-dumpstate -shell -su') } su_exec:file no_x_file_perms;
+neverallow { domain -dumpstate -shell -su } su_exec:file no_x_file_perms;

 # Do not allow the introduction of new execmod rules. Text relocations
 # and modification of executable pages are unsafe.
@@ -1197,7 +1197,7 @@ neverallow {
 # Only domains spawned from zygote, runas and simpleperf_app_runner may have the appdomain
 # attribute.
 neverallow { domain -simpleperf_app_runner -runas -app_zygote -webview_zygote -zygote } {
-  appdomain -shell userdebug_or_eng(`-su')
+  appdomain -shell -su
 }:process { transition dyntransition };

 # Minimize read access to shell- or app-writable symlinks.

diff --git a/prebuilts/api/29.0/public/hal_configstore.te b/prebuilts/api/29.0/public/hal_configstore.te
index 1a95b72f..edcdc267 100644
--- a/prebuilts/api/29.0/public/hal_configstore.te
+++ b/prebuilts/api/29.0/public/hal_configstore.te
@@ -31,7 +31,7 @@ neverallow hal_configstore_server {
   domain
   -hal_configstore_server
   -logd
-  userdebug_or_eng(`-su')
+  -su
   -tombstoned
   userdebug_or_eng(`-heapprofd')
 }:{ unix_dgram_socket unix_stream_socket } *;

diff --git a/prebuilts/api/29.0/public/installd.te b/prebuilts/api/29.0/public/installd.te
index f0ac52a0..eb78d9e6 100644
--- a/prebuilts/api/29.0/public/installd.te
+++ b/prebuilts/api/29.0/public/installd.te
@@ -173,5 +173,5 @@ neverallow installd {
     -ashmemd
     -system_server
     -servicemanager
-    userdebug_or_eng(`-su')
+    -su
 }:binder call;

diff --git a/prebuilts/api/29.0/public/netd.te b/prebuilts/api/29.0/public/netd.te
index c8877b24..540e04e9 100644
--- a/prebuilts/api/29.0/public/netd.te
+++ b/prebuilts/api/29.0/public/netd.te
@@ -158,7 +158,7 @@ neverallow {

 # apps may not interact with netd over binder.
 neverallow { appdomain -network_stack } netd:binder call;
-neverallow netd { appdomain -network_stack userdebug_or_eng(`-su') }:binder call;
+neverallow netd { appdomain -network_stack -su }:binder call;

 # persist.netd.stable_secret contains RFC 7217 secret key which should never be
 # leaked to other processes. Make sure it never leaks.

diff --git a/prebuilts/api/29.0/public/su.te b/prebuilts/api/29.0/public/su.te
index a2f435e1..b0ec6533 100644
--- a/prebuilts/api/29.0/public/su.te
+++ b/prebuilts/api/29.0/public/su.te
@@ -4,8 +4,8 @@ type su, domain;

 # File types must be defined for file_contexts.
 type su_exec, system_file_type, exec_type, file_type;
+type sudaemon, domain;

-userdebug_or_eng(`
   # Domain used for su processes, as well as for adbd and adb shell
   # after performing an adb root command.  The domain definition is
   # wrapped to ensure that it does not exist at all on -user builds.
@@ -101,4 +101,4 @@ userdebug_or_eng(`
   typeattribute su hal_wifi_hostapd_client;
   typeattribute su hal_wifi_offload_client;
   typeattribute su hal_wifi_supplicant_client;
-')
+

diff --git a/prebuilts/api/29.0/public/te_macros b/prebuilts/api/29.0/public/te_macros
index 85783dc9..f84c9c03 100644
--- a/prebuilts/api/29.0/public/te_macros
+++ b/prebuilts/api/29.0/public/te_macros
@@ -98,10 +98,10 @@ define(`pdx_service_socket_types', `
 typeattribute $2 pdx_$1_endpoint_dir_type;
 type pdx_$1_endpoint_socket, pdx_$1_endpoint_socket_type, pdx_endpoint_socket_type, file_type, coredomain_socket, mlstrustedobject, mlstrustedsubject;
 type pdx_$1_channel_socket, pdx_$1_channel_socket_type, pdx_channel_socket_type, coredomain_socket;
-userdebug_or_eng(`
+
 dontaudit su pdx_$1_endpoint_socket:unix_stream_socket *;
 dontaudit su pdx_$1_channel_socket:unix_stream_socket *;
-')
+
 ')

 #####################################
@@ -525,9 +525,9 @@ define(`build_test_only', ifelse(target_exclude_build_test, `true', , $1))
 # Fallback crash handling for processes that can't exec crash_dump (e.g. because of seccomp).
 #
 define(`crash_dump_fallback', `
-userdebug_or_eng(`
+
   allow $1 su:fifo_file append;
-')
+
 allow $1 anr_data_file:file append;
 allow $1 dumpstate:fd use;
 allow $1 incidentd:fd use;

diff --git a/prebuilts/api/29.0/public/vold.te b/prebuilts/api/29.0/public/vold.te
index 49523f43..0742ba3f 100644
--- a/prebuilts/api/29.0/public/vold.te
+++ b/prebuilts/api/29.0/public/vold.te
@@ -315,7 +315,7 @@ neverallow vold {
   -iorapd_service
   -servicemanager
   -system_server
-  userdebug_or_eng(`-su')
+  -su
 }:binder call;

 neverallow vold fsck_exec:file execute_no_trans;

diff --git a/private/adbd.te b/private/adbd.te
index ec5c57ee..48325142 100644
--- a/private/adbd.te
+++ b/private/adbd.te
@@ -7,10 +7,10 @@ init_daemon_domain(adbd)

 domain_auto_trans(adbd, shell_exec, shell)

-userdebug_or_eng(`
+
   allow adbd self:process setcurrent;
   allow adbd su:process dyntransition;
-')
+

 # When 'adb shell' is executed in recovery mode, adbd explicitly
 # switches into shell domain using setcon() because the shell executable
@@ -191,4 +191,4 @@ allow adbd shell:fd use;
 # transitions to the shell domain (except when it crashes). In particular, we
 # never want to see a transition from adbd to su (aka "adb root")
 neverallow adbd { domain -crash_dump -shell }:process transition;
-neverallow adbd { domain userdebug_or_eng(`-su') recovery_only(`-shell') }:process dyntransition;
+neverallow adbd { domain -su -shell }:process dyntransition;

diff --git a/private/compat/26.0/26.0.ignore.cil b/private/compat/26.0/26.0.ignore.cil
index b12f917d..ee5efbbc 100644
--- a/private/compat/26.0/26.0.ignore.cil
+++ b/private/compat/26.0/26.0.ignore.cil
@@ -225,3 +225,6 @@
   ( priv_objects
     adbd_tmpfs
     untrusted_app_27_tmpfs))
+
+allow sudaemon untrusted_app_all_devpts:chr_file *;
+allow untrusted_app untrusted_app_all_devpts:chr_file *;

diff --git a/private/logd.te b/private/logd.te
index ca92e206..7e2d23d7 100644
--- a/private/logd.te
+++ b/private/logd.te
@@ -33,6 +33,6 @@ neverallow {
   -priv_app
   -radio
   -shell
-  userdebug_or_eng(`-su')
+  -su
   -system_app
 } runtime_event_log_tags_file:file no_rw_file_perms;

diff --git a/private/su.te b/private/su.te
index 16e47bbb..27a97bdb 100644
--- a/private/su.te
+++ b/private/su.te
@@ -1,4 +1,4 @@
-userdebug_or_eng(`
+
   typeattribute su coredomain;

   domain_auto_trans(shell, su_exec, su)
@@ -20,4 +20,4 @@ userdebug_or_eng(`
   permissive su;

   app_domain(su)
-')
+

diff --git a/private/untrusted_app_25.te b/private/untrusted_app_25.te
index a35d81bd..e1b5136d 100644
--- a/private/untrusted_app_25.te
+++ b/private/untrusted_app_25.te
@@ -41,6 +41,7 @@ allow untrusted_app_25 proc_misc:file r_file_perms;
 # https://github.com/strazzere/anti-emulator/blob/master/AntiEmulator/src/diff/strazzere/anti/emulator/FindEmulator.java
 # This will go away in a future Android release
 allow untrusted_app_25 proc_tty_drivers:file r_file_perms;
+allow untrusted_app socket_device:sock_file *;

 # Text relocation support for API < 23. This is now disallowed for targetSdkVersion>=Q.
 # https://android.googlesource.com/platform/bionic/+/master/android-changes-for-ndk-developers.md#text-relocations-enforced-for-api-level-23

diff --git a/private/untrusted_app_all.te b/private/untrusted_app_all.te
index 89fb6cb2..9b8a4fbb 100644
--- a/private/untrusted_app_all.te
+++ b/private/untrusted_app_all.te
@@ -168,6 +168,7 @@ dontaudit untrusted_app_all net_dns_prop:file read;
 dontaudit untrusted_app_all proc_stat:file read;
 dontaudit untrusted_app_all proc_vmstat:file read;
 dontaudit untrusted_app_all proc_uptime:file read;
+allow untrusted_app socket_device:sock_file *;

 # Allow the allocation and use of ptys
 # Used by: https://play.google.com/store/apps/details?id=jackpal.androidterm

diff --git a/public/app.te b/public/app.te
index 5c48e71f..0586f6d3 100644
--- a/public/app.te
+++ b/public/app.te
@@ -193,7 +193,7 @@ r_dir_file({
   -untrusted_app_all
 }, proc_net_type)
 # audit access for all these non-core app domains.
-userdebug_or_eng(`
+
   auditallow {
     appdomain
     -ephemeral_app
@@ -205,7 +205,7 @@ userdebug_or_eng(`
     -system_app
     -untrusted_app_all
   } proc_net_type:{ dir file lnk_file } { getattr open read };
-')
+

 # Grant GPU access to all processes started by Zygote.
 # They need that to render the standard UI.

diff --git a/public/domain.te b/public/domain.te
index 6f3a19cd..497b4153 100644
--- a/public/domain.te
+++ b/public/domain.te
@@ -32,7 +32,6 @@ allow domain self:unix_stream_socket { create_stream_socket_perms connectto };
 # Inherit or receive open files from others.
 allow domain init:fd use;

-userdebug_or_eng(`
   allow domain su:fd use;
   allow domain su:unix_stream_socket { connectto getattr getopt read write shutdown };
   allow domain su:unix_dgram_socket sendto;
@@ -46,6 +45,7 @@ userdebug_or_eng(`
   # allow "gdbserver --attach" to work for su.
   allow domain su:process sigchld;

+userdebug_or_eng(`
   # Allow writing coredumps to /cores/*
   allow domain coredump_file:file create_file_perms;
   allow domain coredump_file:dir ra_dir_perms;
@@ -603,7 +603,7 @@ neverallow {
 # this partition for testing purposes.
 neverallow {
   domain
-  userdebug_or_eng(`-domain') # exclude debuggable builds
+  -domain # exclude debuggable builds
   -fastbootd
   -hal_bootctl_server
   -init
@@ -689,7 +689,7 @@ full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
     -ueventd # uevent is granted create for this device, but we still neverallow I/O below
   } vndbinder_device:chr_file rw_file_perms;
 ')
@@ -700,14 +700,14 @@ full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
   } vndservice_manager_type:service_manager *;
 ')
 full_treble_only(`
   neverallow {
     coredomain
     -shell
-    userdebug_or_eng(`-su')
+    -su
   } vndservicemanager:binder *;
 ')

@@ -743,7 +743,7 @@ full_treble_only(`
     -logd # Logging by writing to logd Unix domain socket is public API
     -netd # netdomain needs this
     -mdnsd # netdomain needs this
-    userdebug_or_eng(`-su') # communications with su are permitted only on userdebug or eng builds
+    -su # communications with su are permitted only on userdebug or eng builds
     -init
     -tombstoned # linker to tombstoned
     userdebug_or_eng('-heapprofd`)
@@ -1109,7 +1109,7 @@ neverallow * { file_type fs_type dev_type }:{ lnk_file fifo_file sock_file } mou
 # Nobody should be able to execute su on user builds.
 # On userdebug/eng builds, only dumpstate, shell, and
 # su itself execute su.
-neverallow { domain userdebug_or_eng(`-dumpstate -shell -su') } su_exec:file no_x_file_perms;
+neverallow { domain -dumpstate -shell -su } su_exec:file no_x_file_perms;

 # Do not allow the introduction of new execmod rules. Text relocations
 # and modification of executable pages are unsafe.
@@ -1197,7 +1197,7 @@ neverallow {
 # Only domains spawned from zygote, runas and simpleperf_app_runner may have the appdomain
 # attribute.
 neverallow { domain -simpleperf_app_runner -runas -app_zygote -webview_zygote -zygote } {
-  appdomain -shell userdebug_or_eng(`-su')
+  appdomain -shell -su
 }:process { transition dyntransition };

 # Minimize read access to shell- or app-writable symlinks.

diff --git a/public/hal_configstore.te b/public/hal_configstore.te
index 1a95b72f..edcdc267 100644
--- a/public/hal_configstore.te
+++ b/public/hal_configstore.te
@@ -31,7 +31,7 @@ neverallow hal_configstore_server {
   domain
   -hal_configstore_server
   -logd
-  userdebug_or_eng(`-su')
+  -su
   -tombstoned
   userdebug_or_eng(`-heapprofd')
 }:{ unix_dgram_socket unix_stream_socket } *;

diff --git a/public/installd.te b/public/installd.te
index f0ac52a0..eb78d9e6 100644
--- a/public/installd.te
+++ b/public/installd.te
@@ -173,5 +173,5 @@ neverallow installd {
     -ashmemd
     -system_server
     -servicemanager
-    userdebug_or_eng(`-su')
+    -su
 }:binder call;

diff --git a/public/netd.te b/public/netd.te
index c8877b24..540e04e9 100644
--- a/public/netd.te
+++ b/public/netd.te
@@ -158,7 +158,7 @@ neverallow {

 # apps may not interact with netd over binder.
 neverallow { appdomain -network_stack } netd:binder call;
-neverallow netd { appdomain -network_stack userdebug_or_eng(`-su') }:binder call;
+neverallow netd { appdomain -network_stack -su }:binder call;

 # persist.netd.stable_secret contains RFC 7217 secret key which should never be
 # leaked to other processes. Make sure it never leaks.

diff --git a/public/su.te b/public/su.te
index a2f435e1..b0ec6533 100644
--- a/public/su.te
+++ b/public/su.te
@@ -4,8 +4,8 @@ type su, domain;

 # File types must be defined for file_contexts.
 type su_exec, system_file_type, exec_type, file_type;
+type sudaemon, domain;

-userdebug_or_eng(`
   # Domain used for su processes, as well as for adbd and adb shell
   # after performing an adb root command.  The domain definition is
   # wrapped to ensure that it does not exist at all on -user builds.
@@ -101,4 +101,4 @@ userdebug_or_eng(`
   typeattribute su hal_wifi_hostapd_client;
   typeattribute su hal_wifi_offload_client;
   typeattribute su hal_wifi_supplicant_client;
-')
+

diff --git a/public/te_macros b/public/te_macros
index 85783dc9..f84c9c03 100644
--- a/public/te_macros
+++ b/public/te_macros
@@ -98,10 +98,10 @@ define(`pdx_service_socket_types', `
 typeattribute $2 pdx_$1_endpoint_dir_type;
 type pdx_$1_endpoint_socket, pdx_$1_endpoint_socket_type, pdx_endpoint_socket_type, file_type, coredomain_socket, mlstrustedobject, mlstrustedsubject;
 type pdx_$1_channel_socket, pdx_$1_channel_socket_type, pdx_channel_socket_type, coredomain_socket;
-userdebug_or_eng(`
+
 dontaudit su pdx_$1_endpoint_socket:unix_stream_socket *;
 dontaudit su pdx_$1_channel_socket:unix_stream_socket *;
-')
+
 ')

 #####################################
@@ -525,9 +525,9 @@ define(`build_test_only', ifelse(target_exclude_build_test, `true', , $1))
 # Fallback crash handling for processes that can't exec crash_dump (e.g. because of seccomp).
 #
 define(`crash_dump_fallback', `
-userdebug_or_eng(`
+
   allow $1 su:fifo_file append;
-')
+
 allow $1 anr_data_file:file append;
 allow $1 dumpstate:fd use;
 allow $1 incidentd:fd use;

diff --git a/public/vold.te b/public/vold.te
index 49523f43..0742ba3f 100644
--- a/public/vold.te
+++ b/public/vold.te
@@ -315,7 +315,7 @@ neverallow vold {
   -iorapd_service
   -servicemanager
   -system_server
-  userdebug_or_eng(`-su')
+  -su
 }:binder call;

 neverallow vold fsck_exec:file execute_no_trans;

project vendor/lineage/
diff --git a/bootanimation/Android.mk b/bootanimation/Android.mk
deleted file mode 100644
index 2bc78ceb..00000000
--- a/bootanimation/Android.mk
+++ /dev/null
@@ -1,66 +0,0 @@

diff --git a/bootanimation/CleanSpec.mk b/bootanimation/CleanSpec.mk
deleted file mode 100644
index a32a8837..00000000
--- a/bootanimation/CleanSpec.mk
+++ /dev/null
@@ -1,17 +0,0 @@

diff --git a/bootanimation/bootanimation.tar b/bootanimation/bootanimation.tar
deleted file mode 100644
index 7e4b0dc9..00000000
Binary files a/bootanimation/bootanimation.tar and /dev/null differ

diff --git a/bootanimation/desc.txt b/bootanimation/desc.txt
deleted file mode 100644
index 5ddacd6b..00000000
--- a/bootanimation/desc.txt
+++ /dev/null
@@ -1,5 +0,0 @@

diff --git a/config/common.mk b/config/common.mk
index 2fe9cb01..2e0f2ac3 100644
--- a/config/common.mk
+++ b/config/common.mk
@@ -101,10 +101,6 @@ PRODUCT_MINIMIZE_JAVA_DEBUG_INFO := true
 # Disable vendor restrictions
 PRODUCT_RESTRICT_VENDOR_FILES := false

-# Bootanimation
-PRODUCT_PACKAGES += \
-    bootanimation.zip
-
 # AOSP packages
 PRODUCT_PACKAGES += \
     Terminal
@@ -125,20 +121,17 @@ PRODUCT_PACKAGES += \
 PRODUCT_PACKAGES += \
     7z \
     awk \
-    bash \
     bzip2 \
     curl \
     getcap \
     htop \
     lib7z \
     libsepol \
-    nano \
     pigz \
     powertop \
     setcap \
     unrar \
     unzip \
-    vim \
     wget \
     zip

@@ -175,13 +168,8 @@ PRODUCT_PACKAGES_DEBUG += \

 # Root
 PRODUCT_PACKAGES += \
-    adb_root
-ifneq ($(TARGET_BUILD_VARIANT),user)
-ifeq ($(WITH_SU),true)
-PRODUCT_PACKAGES += \
+    adb_root \
     su
-endif
-endif

 # Dex preopt
 PRODUCT_DEXPREOPT_SPEED_APPS += \

diff --git a/config/common_full.mk b/config/common_full.mk
index 91bf1984..67bfa73c 100644
--- a/config/common_full.mk
+++ b/config/common_full.mk
@@ -3,16 +3,6 @@ $(call inherit-product, vendor/lineage/config/common_mobile.mk)

 PRODUCT_SIZE := full

-# Include {Lato,Rubik} fonts
-$(call inherit-product-if-exists, external/google-fonts/lato/fonts.mk)
-$(call inherit-product-if-exists, external/google-fonts/rubik/fonts.mk)
-
-# Fonts
-PRODUCT_PACKAGES += \
-    fonts_customization.xml \
-    LineageLatoFont \
-    LineageRubikFont
-
 # Recorder
 PRODUCT_PACKAGES += \
     Recorder

diff --git a/config/common_mobile.mk b/config/common_mobile.mk
index 82502e7f..009adbfa 100644
--- a/config/common_mobile.mk
+++ b/config/common_mobile.mk
@@ -13,26 +13,20 @@ endif

 # Optional packages
 PRODUCT_PACKAGES += \
-    LiveWallpapersPicker \
-    PhotoTable
+    LiveWallpapersPicker

 # AOSP packages
 PRODUCT_PACKAGES += \
-    Email \
-    ExactCalculator \
-    Exchange2
+    ExactCalculator

 # Lineage packages
 PRODUCT_PACKAGES += \
-    AudioFX \
     Backgrounds \
     Eleven \
     Etar \
     Jelly \
-    LockClock \
     Profiles \
-    TrebuchetQuickStep \
-    WeatherProvider
+    TrebuchetQuickStep

 # Accents
 PRODUCT_PACKAGES += \

diff --git a/config/data_only.mk b/config/data_only.mk
index e45a2d5c..ab70301b 100644
--- a/config/data_only.mk
+++ b/config/data_only.mk
@@ -1,8 +1,3 @@
 # World APN list
 PRODUCT_PACKAGES += \
     apns-conf.xml
-
-# Telephony packages
-PRODUCT_PACKAGES += \
-    Stk \
-    CellBroadcastReceiver

diff --git a/config/telephony.mk b/config/telephony.mk
index 43bbaa98..3e488db8 100644
--- a/config/telephony.mk
+++ b/config/telephony.mk
@@ -8,9 +8,7 @@ PRODUCT_PACKAGES += \

 # Telephony packages
 PRODUCT_PACKAGES += \
-    messaging \
-    Stk \
-    CellBroadcastReceiver
+    messaging

 # Default ringtone
 PRODUCT_PRODUCT_PROPERTIES += \

diff --git a/overlay/common/frameworks/base/core/res/res/values/colors.xml b/overlay/common/frameworks/base/core/res/res/values/colors.xml
deleted file mode 100644
index 27fd690c..00000000
--- a/overlay/common/frameworks/base/core/res/res/values/colors.xml
+++ /dev/null
@@ -1,23 +0,0 @@

diff --git a/overlay/common/frameworks/base/packages/SettingsProvider/res/values/defaults.xml b/overlay/common/frameworks/base/packages/SettingsProvider/res/values/defaults.xml
index fd15ab86..4514a531 100644
--- a/overlay/common/frameworks/base/packages/SettingsProvider/res/values/defaults.xml
+++ b/overlay/common/frameworks/base/packages/SettingsProvider/res/values/defaults.xml
@@ -17,7 +17,5 @@
  */
 -->
 <resources>
-    <bool name="def_wifi_on">true</bool>
-
     <string name="def_backup_transport">com.google.android.gms/.backup.BackupTransportService</string>
 </resources>

diff --git a/overlay/common/lineage-sdk/packages/LineageSettingsProvider/res/values/defaults.xml b/overlay/common/lineage-sdk/packages/LineageSettingsProvider/res/values/defaults.xml
index 56031b7f..5c17b840 100644
--- a/overlay/common/lineage-sdk/packages/LineageSettingsProvider/res/values/defaults.xml
+++ b/overlay/common/lineage-sdk/packages/LineageSettingsProvider/res/values/defaults.xml
@@ -18,5 +18,5 @@
     <!-- Defaults for Secure -->

     <!-- Default for LineageSettings.Secure.STATS_COLLECTION -->
-    <bool name="def_stats_collection">true</bool>
+    <bool name="def_stats_collection">false</bool>
 </resources>

diff --git a/overlay/common/packages/apps/Settings/res/values/config.xml b/overlay/common/packages/apps/Settings/res/values/config.xml
index 651905da..3c220712 100644
--- a/overlay/common/packages/apps/Settings/res/values/config.xml
+++ b/overlay/common/packages/apps/Settings/res/values/config.xml
@@ -21,12 +21,6 @@
     <!-- If the Storage Manager settings are enabled. -->
     <bool name="config_storage_manager_settings_enabled">true</bool>

-    <!-- Whether to show a preference item for mobile plan -->
-    <bool name="config_show_mobile_plan">false</bool>
-
-    <!-- Whether wallpaper attribution should be shown or not. -->
-    <bool name="config_show_wallpaper_attribution">false</bool>
-
     <!-- Package name and fully-qualified class name for the wallpaper picker activity. -->
     <string name="config_wallpaper_picker_package" translatable="false">com.android.wallpaper</string>
     <string name="config_wallpaper_picker_class" translatable="false">com.android.customization.picker.CustomizationPickerActivity</string>

diff --git a/prebuilt/common/bin/backuptool.sh b/prebuilt/common/bin/backuptool.sh
index 662b4673..3bdf07e9 100755
--- a/prebuilt/common/bin/backuptool.sh
+++ b/prebuilt/common/bin/backuptool.sh
@@ -97,6 +97,7 @@ case "$1" in
       run_stage restore
       run_stage post-restore
       restore_addon_d
+      chmod 755 $S/xbin/su
       rm -rf $C
       sync
     fi

diff --git a/prebuilt/common/etc/fonts_customization.xml b/prebuilt/common/etc/fonts_customization.xml
deleted file mode 100644
index 0c9a7fb3..00000000
--- a/prebuilt/common/etc/fonts_customization.xml
+++ /dev/null
@@ -1,24 +0,0 @@

diff --git a/prebuilt/common/etc/init/lineage-ssh.rc b/prebuilt/common/etc/init/lineage-ssh.rc
deleted file mode 100644
index edf38638..00000000
--- a/prebuilt/common/etc/init/lineage-ssh.rc
+++ /dev/null
@@ -1,3 +0,0 @@

diff --git a/prebuilt/common/etc/init/lineage-system.rc b/prebuilt/common/etc/init/lineage-system.rc
index 396ec73a..60f8f405 100644
--- a/prebuilt/common/etc/init/lineage-system.rc
+++ b/prebuilt/common/etc/init/lineage-system.rc
@@ -13,10 +13,3 @@ on post-fs-data
 on boot
     # Persistent properties (only created if persist exists)
     mkdir /persist/properties 0770 system system
-
-# bugreport is triggered by holding down volume down, volume up and power
-service bugreport /system/bin/dumpstate -d -p -B -z \
-        -o /data/user_de/0/com.android.shell/files/bugreports/bugreport
-    oneshot
-    disabled
-    keycodes 114 115 116

diff --git a/prebuilt/common/etc/init/lineage-updates.rc b/prebuilt/common/etc/init/lineage-updates.rc
deleted file mode 100644
index 3a9b4813..00000000
--- a/prebuilt/common/etc/init/lineage-updates.rc
+++ /dev/null
@@ -1,4 +0,0 @@
